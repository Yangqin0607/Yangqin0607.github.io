<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.6" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/html_small.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/html_big.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/html_big.png?v=6.0.6">


  <link rel="mask-icon" href="/images/html.svg?v=6.0.6" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.6',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Front End Engineer">
<meta property="og:type" content="website">
<meta property="og:title" content="Ailsa&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Ailsa&#39;s blog">
<meta property="og:description" content="Front End Engineer">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ailsa&#39;s blog">
<meta name="twitter:description" content="Front End Engineer">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Ailsa's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ailsa's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Front End Engineer</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
</li>

      

      
    </ul>
  

  
    

  

  
</nav>


  



 </div>
    </header>

    
  
  
  
    
      
    
    <a href="https://github.com/Yangqin0607" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg>
    
      </a>
    



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/04/surviveJS-webpack-optimizing/" itemprop="url">surviveJS-webpack-optimizing 学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-04T16:18:21+08:00">2018-05-04</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/04/surviveJS-webpack-optimizing/" class="leancloud_visitors" data-flag-title="surviveJS-webpack-optimizing 学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><a href="https://survivejs.com/webpack/optimizing/" target="_blank" rel="noopener">surviveJS-webpack-optimizing</a></strong></p>
<h1 id="Minifying"><a href="#Minifying" class="headerlink" title="Minifying"></a>Minifying</h1><p>webpack4 mode为production时，默认会使用UglifyJS来压缩代码。压缩代码就是把代码转换为体积更小的形式。安全转换在压缩代码的同时不会改变代码的作用，比如重命名变量名或者删除一些不可能执行的代码（if(false)）。非安全转换可能会破坏代码，因为可能会丢失底层代码隐含的某些内容，比如angular1 使用模块时，函数变量名是特定的，改写变量名就会破坏代码功能。</p>
<h2 id="Modifying-JavaScript-Minification-Process"><a href="#Modifying-JavaScript-Minification-Process" class="headerlink" title="Modifying JavaScript Minification Process"></a>Modifying JavaScript Minification Process</h2><p>webpack4 中提供了两个配置项来控制压缩过程：<code>optimization.minimize</code>来开关压缩功能，<code>optimization.minimizer</code>数组来配置过程。<br>为了调整默认行为，我们添加<code>uglifyjs-webpack-plugin</code>到我们的例子中。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add uglifyjs-webpack-plugin -D</span><br></pre></td></tr></table></figure></p>
<p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UglifyWebpackPlugin = <span class="built_in">require</span>(<span class="string">"uglifyjs-webpack-plugin"</span>);</span><br><span class="line"></span><br><span class="line">exports.minifyJavaScript = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    minimizer: [<span class="keyword">new</span> UglifyWebpackPlugin(&#123; <span class="attr">sourceMap</span>: <span class="literal">true</span> &#125;)],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  parts.clean(PATHS.build),</span><br><span class="line"></span><br><span class="line">  parts.minifyJavaScript(),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>编译后结果应该跟之前一样，但是通过这种方式使用的是最新的UglifyJS版本。<br>source map默认是关闭的，可以通过sourceMap开启。如果需要在打包后的代码中删除console.log，可以设置<code>uglifyOptions.compress.drop_console</code>为true。</p>
<h2 id="Speeding-Up-JavaScript-Execution"><a href="#Speeding-Up-JavaScript-Execution" class="headerlink" title="Speeding Up JavaScript Execution"></a>Speeding Up JavaScript Execution</h2><blockquote>
<p>Specific solutions allow you to preprocess code so that it will run faster. They complement the minification technique and can be split into scope hoisting, pre-evaluation, and improving parsing. It’s possible these techniques grow overall bundle size sometimes while allowing faster execution.</p>
</blockquote>
<h3 id="scope-hoisting"><a href="#scope-hoisting" class="headerlink" title="scope hoisting"></a>scope hoisting</h3><p>webpack 4 在生产模式自动应用了scope hoisting。过去 webpack 打包时将 bundle 中各个模块单独打包成闭包。这些打包函数使你的 JavaScript 在浏览器中处理的更慢。相比之下，一些工具像 Closure Compiler 和 RollupJS 可以提升(hoist)或者预编译所有模块到一个闭包中，提升你的代码在浏览器中的执行速度。<a href="https://medium.com/webpack/brief-introduction-to-scope-hoisting-in-webpack-8435084c171f" target="_blank" rel="noopener">webpack scope hositing 博客</a></p>
<p>在<a href="http://yangqin0607.coding.me/2018/04/05/surviveJS-webpack-developing/" target="_blank" rel="noopener">developing学习笔记</a>中，我们看了webpack输出的打包文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123; <span class="comment">// webpackBootstrap</span></span><br><span class="line">  <span class="comment">// The module cache</span></span><br><span class="line">  <span class="keyword">var</span> installedModules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The require function</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">      </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  __webpack_require__.xxx = xxx</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// __webpack_public_path__</span></span><br><span class="line">  __webpack_require__.p = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load entry module and return exports</span></span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="string">"./src/index.js"</span>);</span><br><span class="line">&#125;)</span><br><span class="line">(&#123;</span><br><span class="line"> <span class="string">"./src/component.js"</span>:(<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123; &#125;),</span><br><span class="line"> <span class="string">"./src/index.js"</span>: (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123; &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如下，没有使用scope hoisting的时候，index.js中引入component.js时，会使用<code>_webpack_require_(&quot;./src/component.js&quot;)</code>,然后我们开启下scope hoisting，对比下webpack会怎么处理component.js。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">  "use strict"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> _component = __webpack_require__(<span class="comment">/*! ./component */</span> <span class="string">"./src/component.js"</span>);</span><br><span class="line">  <span class="keyword">var</span> _component2 = _interopRequireDefault(_component);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123; <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="attr">default</span>: obj &#125;; &#125;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild((<span class="number">0</span>, _component2.default)());</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure>
<p>由于实现 ECMAScript 模块语法,scope hoisting这个特定于此语法的功能才成为可能。webpack 可能会根据你正在使用的模块类型和其他的情况，回退到普通打包。此插件仅适用于由 webpack 直接处理的 ES6 模块。在使用转译器(transpiler)时，你需要禁用对模块的处理（例如 Babel 中的 modules 选项）。所以开启scope hoisting，还需要在.babelrc中设置<code>{modules:false}</code>，禁用对模块的处理。<br>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exports.hoistCode = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  plugins: [<span class="keyword">new</span> webpack.optimize.ModuleConcatenationPlugin()]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>.babelrc<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>:[</span><br><span class="line">    [</span><br><span class="line">      <span class="string">"env"</span>,</span><br><span class="line">      &#123;<span class="attr">"modules"</span>:<span class="literal">false</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>开启scope hoisting，index.js打包内容如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">  "use strict"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// CONCATENATED MODULE: ./src/component.js</span></span><br><span class="line">  <span class="comment">/* harmony default export */</span> <span class="keyword">var</span> component = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> text = <span class="built_in">arguments</span>.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">arguments</span>[<span class="number">0</span>] !== <span class="literal">undefined</span> ? <span class="built_in">arguments</span>[<span class="number">0</span>] : <span class="string">'Hello world'</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">var</span> element = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">    element.innerHTML = text;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">    &#125;);</span><br><span class="line">  <span class="keyword">var</span> a = <span class="string">"123"</span>;</span><br><span class="line">  <span class="comment">// CONCATENATED MODULE: ./src/index.js</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(component());</span><br><span class="line"></span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure></p>
<p>可以看到component.js直接被引入到了index.js中，而不是单独封装了。<br>给webpack传递<code>--display-optimization-bailout</code>标志，可以debug跟scope hoisting相关的信息。</p>
<h3 id="pre-evaluation"><a href="#pre-evaluation" class="headerlink" title="pre-evaluation"></a>pre-evaluation</h3><p><a href="https://www.npmjs.com/package/prepack-webpack-plugin" target="_blank" rel="noopener"><code>prepack-webpack-plugin</code></a>会在编译阶段做一些计算，从而加快代码执行时速度。该插件使用的是<a href="https://prepack.io/" target="_blank" rel="noopener">Prepack</a>。举个简单的例子：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="string">'hello'</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">world</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="string">'world'</span>; &#125;</span><br><span class="line">  global.s = hello() + <span class="string">' '</span> + world();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<p>用prepack编译后为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">"hello world"</span>;</span><br></pre></td></tr></table></figure></p>
<p>但是这个plugin跟旧的webpack有冲突，<a href="https://github.com/gajus/prepack-loader/issues/2" target="_blank" rel="noopener">issues</a>。类似的工具还有：<code>val-loader</code> and <code>babel-plugin-preval</code></p>
<h2 id="Minifying-HTML"><a href="#Minifying-HTML" class="headerlink" title="Minifying HTML"></a>Minifying HTML</h2><blockquote>
<p>If you consume HTML templates through your code using html-loader, you can preprocess it through posthtml with posthtml-loader. You can use posthtml-minifier to minify your HTML through it.</p>
</blockquote>
<h2 id="Minifying-CSS"><a href="#Minifying-CSS" class="headerlink" title="Minifying CSS"></a>Minifying CSS</h2><p><code>css-loader</code>允许通过<a href="http://cssnano.co/guides/getting-started/" target="_blank" rel="noopener">cssnano</a>来压缩css，需要通过minimize显式开启压缩功能。也可以给cssnano<a href="http://cssnano.co/optimisations/" target="_blank" rel="noopener">传参</a>来定制压缩行为。<br><code>clean-css-loader</code>允许使用css压缩工具<code>clean-css</code>.<br><code>optimize-css-assets-webpack-plugin</code>能压缩css输出。使用<code>ExtractTextPlugin</code>会导致重复的CSS,因为它只是合并text chunks。<code>optimize-css-assets-webpack-plugin</code>不会产生这个问题。</p>
<p>在这些可选的方案中，<code>optimize-css-assets-webpack-plugin</code>比较好用，下面我们试用一下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add optimize-css-assets-webpack-plugin cssnano -D</span><br></pre></td></tr></table></figure></p>
<p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> OptimizeCSSAssetsPlugin = <span class="built_in">require</span>(</span><br><span class="line">  <span class="string">"optimize-css-assets-webpack-plugin"</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">const</span> cssnano = <span class="built_in">require</span>(<span class="string">"cssnano"</span>);</span><br><span class="line"></span><br><span class="line">exports.minifyCSS = <span class="function">(<span class="params">&#123; options &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> OptimizeCSSAssetsPlugin(&#123;</span><br><span class="line">      cssProcessor: cssnano,</span><br><span class="line">      cssProcessorOptions: options,</span><br><span class="line">      canPrint: <span class="literal">false</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>如果我们要使用–json，比如<code>webpack --env production --json &gt; stats.json</code>,需要设置<code>canPrint:false</code>。<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  ...</span><br><span class="line">  parts.minifyJavaScript(),</span><br><span class="line"></span><br><span class="line">  parts.minifyCSS(&#123;</span><br><span class="line">    options: &#123;</span><br><span class="line">      discardComments: &#123;</span><br><span class="line">        removeAll: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// Run cssnano in safe mode to avoid</span></span><br><span class="line">      <span class="comment">// potentially unsafe transformations.</span></span><br><span class="line">      safe: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>配置前</th>
<th style="text-align:center">配置后</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/2018/05/04/surviveJS-webpack-optimizing/minifycss1.png" alt=""></td>
<td style="text-align:center"><img src="/2018/05/04/surviveJS-webpack-optimizing/minifycss2.png" alt=""></td>
<td>两个body样式合并到了一起</td>
</tr>
<tr>
<td><img src="/2018/05/04/surviveJS-webpack-optimizing/minifycss3.png" alt=""></td>
<td style="text-align:center"><img src="/2018/05/04/surviveJS-webpack-optimizing/minifycss4.png" alt=""></td>
<td>css文件缩小了</td>
</tr>
</tbody>
</table>
<h2 id="Minifying-Images"><a href="#Minifying-Images" class="headerlink" title="Minifying Images"></a>Minifying Images</h2><blockquote>
<p>Image size can be reduced by using img-loader, imagemin-webpack, and imagemin-webpack-plugin. The packages use image optimizers underneath.</p>
</blockquote>
<blockquote>
<p>It can be a good idea to use cache-loader and thread-loader with these as discussed in the Performance chapter given they can be substantial operations.</p>
</blockquote>
<h1 id="Tree-Shaking"><a href="#Tree-Shaking" class="headerlink" title="Tree Shaking"></a>Tree Shaking</h1><p>tree shaking 是一个术语，通常用于描述移除 JavaScript 上下文中的未引用代码(dead-code)。它依赖于 ES2015 模块系统中的<a href="http://exploringjs.com/es6/ch_modules.html#static-module-structure" target="_blank" rel="noopener">静态结构特性</a>，例如 import 和 export。因此我们需要配置babel的<code>modules:false</code>。</p>
<h2 id="Demonstrating-Tree-Shaking"><a href="#Demonstrating-Tree-Shaking" class="headerlink" title="Demonstrating Tree Shaking"></a>Demonstrating Tree Shaking</h2><p>src/shake.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shake = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"shake"</span>);</span><br><span class="line"><span class="keyword">const</span> bake = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"bake"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; shake, bake &#125;;</span><br></pre></td></tr></table></figure></p>
<p>src/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bake &#125; <span class="keyword">from</span> <span class="string">"./shake"</span>;</span><br><span class="line"></span><br><span class="line">bake();</span><br></pre></td></tr></table></figure></p>
<p><code>yarn run prod</code>编译文件，在dist/main.js中搜索’shake’，会发现找不到，因为被删掉了。我们还可以通过<code>yarn run prod --display-used-exports</code>来查看shake信息。<br><img src="/2018/05/04/surviveJS-webpack-optimizing/treeshake1.png" alt=""></p>
<p>这里我们直接就可以shake unused code，是因为webpack 4的生产环境默认使用了<code>uglifyJSPlugin</code>。另外需要shake 无用的css modules的话，可以使用<a href="https://github.com/simlrh/dead-css-loader" target="_blank" rel="noopener">dead-css-loader</a>;</p>
<h2 id="Tree-Shaking-on-Package-Level"><a href="#Tree-Shaking-on-Package-Level" class="headerlink" title="Tree Shaking on Package Level"></a>Tree Shaking on Package Level</h2><p>为了能正常使用webpack的tree shaking，我们需要让webpack自己处理ES2015的modules，在babel的配置中，设置<code>modules:false</code>。此外为了能shake外部依赖，我们可以使用<a href="https://www.npmjs.com/package/babel-plugin-transform-imports" target="_blank" rel="noopener"><code>babel-plugin-transform-imports</code></a>重写imports,如下面这种方式<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Row, Grid <span class="keyword">as</span> MyGrid &#125; <span class="keyword">from</span> <span class="string">'react-bootstrap'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; merge &#125; <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br></pre></td></tr></table></figure></p>
<p>修改为下面这种方式引入<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Row <span class="keyword">from</span> <span class="string">'react-bootstrap/lib/Row'</span>;</span><br><span class="line"><span class="keyword">import</span> MyGrid <span class="keyword">from</span> <span class="string">'react-bootstrap/lib/Grid'</span>;</span><br><span class="line"><span class="keyword">import</span> merge <span class="keyword">from</span> <span class="string">'lodash/merge'</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><blockquote>
<p>Tree shaking is a potentially powerful technique. For the source to benefit from tree shaking, npm packages have to be implemented using the ES2015 module syntax, and they have to expose the ES2015 version through package.json module field tools like webpack can pick up.</p>
</blockquote>
<blockquote>
<p>As a package author, you can provide a version of your package that contains ES2015 modules, while the rest has been transpiled to ES5. <a href="https://www.webpackjs.com/guides/tree-shaking/#%E5%B0%86%E6%96%87%E4%BB%B6%E6%A0%87%E8%AE%B0%E4%B8%BA%E6%97%A0%E5%89%AF%E4%BD%9C%E7%94%A8-side-effect-free-" target="_blank" rel="noopener">Set sideEffect for package.json</a><br>eg: ramda package.json <code>side-effects:false</code></p>
</blockquote>
<h1 id="Environment-Variables"><a href="#Environment-Variables" class="headerlink" title="Environment Variables"></a>Environment Variables</h1><p>之前说过压缩Javascript代码时，会移除dead code (if(false))。webpack的<code>DefinePlugin</code>允许替换自由变量，这样我们就可以将<code>if (process.env.NODE_ENV === &quot;development&quot;)</code>这类代码根据当前环境转换为<code>if (true)</code>或者<code>if (false)</code>。<br>webpack 4会根据提供的mode来设置<code>process.env.NODE_ENV</code>,但我们有必要了解一下这方面的知识。</p>
<h2 id="The-Basic-Idea-of-DefinePlugin"><a href="#The-Basic-Idea-of-DefinePlugin" class="headerlink" title="The Basic Idea of DefinePlugin"></a>The Basic Idea of DefinePlugin</h2><p>我们先来看个例子：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Not free due to "foo" above, not ok to replace</span></span><br><span class="line"><span class="keyword">if</span> (foo === <span class="string">"bar"</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"bar"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Free since you don't refer to "bar", ok to replace</span></span><br><span class="line"><span class="keyword">if</span> (bar === <span class="string">"bar"</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"bar"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在上面这个例子中foo变量，一开始已经定义过了，所以不是自由变量，但是下面的bar，上下文中并没有定义，属于自由变量，如果在DefinePlugin中定义了这个变量，就会用DefinePlugin中定义的值来替换bar。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">"foobar"</span> === <span class="string">"bar"</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"bar"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里进一步分析就知道<code>&quot;foobar&quot; === &quot;bar&quot;</code>的值为false，所以这段代码就可以替换为<code>if(false)</code>即dead 代码，被shake掉。</p>
<h2 id="using-DefinePlugin"><a href="#using-DefinePlugin" class="headerlink" title="using DefinePlugin"></a>using DefinePlugin</h2><p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"></span><br><span class="line">exports.setFreeVariable = <span class="function">(<span class="params">key, value</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> env = &#123;&#125;;</span><br><span class="line">  env[key] = <span class="built_in">JSON</span>.stringify(value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    plugins: [<span class="keyword">new</span> webpack.DefinePlugin(env)],</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commonConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parts.setFreeVariable(<span class="string">"HELLO"</span>, <span class="string">"hello from config"</span>),</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>src/component.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (text = HELLO) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> element = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>如果不使用DefinePlugin定义HELLO，运行的时候会报错，HELLO is not defined。使用DefinePlugin定以后，HELLO为自由变量，会去寻找DefinePlugin是否需要替换这个变量，所以按钮的文案替换为了<code>hello from config</code>。<br><a href="https://www.npmjs.com/package/webpack-conditional-loader" target="_blank" rel="noopener">webpack-conditional-loader</a>根据代码注释做相似的操作，但是可以删掉整个dead code，这样能使你的bundle更小，应用加载也更快。</p>
<p><code>webpack.EnvironmentPlugin([&quot;NODE_ENV&quot;])</code>插件也可以引用环境变量，底层实现依赖DefinePlugin，也可以使用<code>process.env.NODE_ENV</code>实现。</p>
<h2 id="Choosing-Which-Module-to-Use"><a href="#Choosing-Which-Module-to-Use" class="headerlink" title="Choosing Which Module to Use"></a>Choosing Which Module to Use</h2><p>本章讨论的技术可以用来根据环境选择加载某个模块。正如上面的示例看到的，DefinePlugin可以决定使用哪些代码，丢弃哪些代码。我们也可以把这种思想用在模块加载上，比如index.js中需要根据环境来加载不同的文件，就可以这样写:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">"production"</span>) &#123;</span><br><span class="line">  <span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">"./store.prod"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">"./store.dev"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Adding-Hashes-to-Filenames"><a href="#Adding-Hashes-to-Filenames" class="headerlink" title="Adding Hashes to Filenames"></a>Adding Hashes to Filenames</h1><p>现在我们的示例中编译后的文件都以文件名来命名，这样就不能有效的利用客户端缓存，因为客户端无法根据文件名来区分这个文件是否改变，我们可以通过在文件名中加入hash来利用缓存。</p>
<h2 id="placeholders"><a href="#placeholders" class="headerlink" title="placeholders"></a>placeholders</h2><p>webpack提供了一些placeholders，这些字符串会将相关的信息附加在webpack的输出上：</p>
<ul>
<li>[id]: 返回chunk id</li>
<li>[path]: 返回文件路径</li>
<li>[name]: 返回文件名</li>
<li>[ext]: 返回扩展名。大部分情况下是可用的，但MiniCssExtractPlugin是个例外。</li>
<li>[hash]: 返回编译哈希。如果编译生成的任何部分发生变化，hash值也会发生变化。</li>
<li>[chunkhash]: 返回入口特定chunk的hash。配置文件中定义的每个入口都有自己的hash。如果某个入口的任何部分发生了变化，这个入口的hash就会改变。</li>
<li>[contenthash]: 返回根据内容生成的hash。</li>
</ul>
<p>最好只在生产环境使用特定的hash或者chunkhash，因为在开发环境hash并没有很多好处。</p>
<p>我们还可以分隔hash或者chunkhash的长度，比如<code>[chunkhash:4]</code>，如果hash为8c4cbfdb91ff93f3f3c5，那么只会截取前4位为8c4c。</p>
<h2 id="Example-placeholder"><a href="#Example-placeholder" class="headerlink" title="Example placeholder"></a>Example placeholder</h2><p>假设你的配置如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: PATHS.build,</span><br><span class="line">    filename: <span class="string">"[name].[chunkhash].js"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>webpack生成的文件如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">main.d587bbd6e38337f5accd.js</span><br><span class="line">vendor.dc746a5db4ed650296e1.js</span><br></pre></td></tr></table></figure></p>
<p>如果某个chunk的文件内容改变，hash值就会改变，因此客户端缓存的该chunk失效，浏览器会请求新的文件。如果只有main bundle发生了更新，那么只会请求main。</p>
<h2 id="Setting-Up-Hashing"><a href="#Setting-Up-Hashing" class="headerlink" title="Setting Up Hashing"></a>Setting Up Hashing</h2><p>图片和字体应该使用hash，chunks应该使用chunkhash，所以可以这样设置：<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    output: &#123;</span><br><span class="line">      chunkFilename: <span class="string">"[name].[chunkhash:4].js"</span>,</span><br><span class="line">      filename: <span class="string">"[name].[chunkhash:4].js"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  parts.loadImages(&#123;</span><br><span class="line">    options: &#123;</span><br><span class="line">      limit: <span class="number">15000</span>,</span><br><span class="line">      name: <span class="string">"[name].[hash:4].[ext]"</span>,</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>对于<code>file-loader</code>，[hash]的定义不同于webpack中其他资源，它是根据文件内容计算的。因此这里图片都是用hash。此外，如果你对抽出的css文件使用chunkhash，那么在JS代码中引用css，会将css带入同一个entry，这意味着如果应用代码或者css改变，两个文件的文件名都会被改变。因此，你可以使用contenthash来代替chunkhash，因为contenthash是基于抽出的文件内容生成的，这样只有在样式文件内容发生改变时，抽出的文件hash才会发生变化。</p>
<p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>);</span><br><span class="line">exports.extractCSS = <span class="function">(<span class="params">&#123; include, exclude, use &#125; = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> plugin = <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">    filename: <span class="string">'styles/[name].[contenthash:4].css'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">      rules: [</span><br><span class="line">        &#123;</span><br><span class="line">          test: <span class="regexp">/\.css/</span>,</span><br><span class="line">          include,</span><br><span class="line">          exclude,</span><br><span class="line">          use: [MiniCssExtractPlugin.loader].concat(use),</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [plugin],</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里把以前的<code>extract-text-webpack-plugin</code>换成了<code>mini-css-extract-plugin</code>,因为使用contenthash时，<code>extract-text-webpack-plugin</code>会报错，可以参考这个<a href="https://github.com/webpack-contrib/extract-text-webpack-plugin/issues/763" target="_blank" rel="noopener">issue</a></p>
<p>编译运行一下，可以看到文件名都带有了hash值：<br><img src="/2018/05/04/surviveJS-webpack-optimizing/hash1.png" alt=""></p>
<p>现在还有个问题，如果修改应用代码，会导致vendor的hash值也发生变化。解决这个问题需要导出manifest.</p>
<h1 id="Separating-a-Manifest"><a href="#Separating-a-Manifest" class="headerlink" title="Separating a Manifest"></a>Separating a Manifest</h1><p>webpack在打包bundle时，会保存一份manifest，在我们示例的vendor bundle中可以找到。manifest描述了webpack应该加载的文件，我们可以抽出manifest，能更快的加载文件，而不用等到vendor bundle加载完。<br>如果webpack生成的hash改变了，manifest也会改变，因此vendor bundle也会改变。所以我们应该抽出manifest为一个单独的文件，或者内联到index.html中。</p>
<h2 id="Extracting-a-Manifest"><a href="#Extracting-a-Manifest" class="headerlink" title="Extracting a Manifest"></a>Extracting a Manifest</h2><p>配置<code>optimization.runtimeChunk</code>可以抽出manifest:<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  ...</span><br><span class="line">  &#123;</span><br><span class="line">    optimization: &#123;</span><br><span class="line">      splitChunks: &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      runtimeChunk: &#123;</span><br><span class="line">        name: <span class="string">"manifest"</span>, <span class="comment">// manifest表示输出的文件名，可以用其他名字代替</span></span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>编译运行如下：<br><img src="/2018/05/04/surviveJS-webpack-optimizing/manifest1.png" alt=""></p>
<p>manifest.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// webpackBootstrap</span></span><br><span class="line">  <span class="comment">// install a JSONP callback for chunk loading</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">webpackJsonpCallback</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> chunkIds = data[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> moreModules = data[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">var</span> executeModules = data[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// add "moreModules" to the modules object,</span></span><br><span class="line">    <span class="comment">// then flag all "chunkIds" as loaded and fire callback</span></span><br><span class="line">    <span class="keyword">var</span> moduleId,</span><br><span class="line">      chunkId,</span><br><span class="line">      i = <span class="number">0</span>,</span><br><span class="line">      resolves = [];</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; chunkIds.length; i++) &#123;</span><br><span class="line">      chunkId = chunkIds[i];</span><br><span class="line">      <span class="keyword">if</span> (installedChunks[chunkId]) &#123;</span><br><span class="line">        resolves.push(installedChunks[chunkId][<span class="number">0</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">      installedChunks[chunkId] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (moduleId <span class="keyword">in</span> moreModules) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(moreModules, moduleId)) &#123;</span><br><span class="line">        modules[moduleId] = moreModules[moduleId];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (parentJsonpFunction) parentJsonpFunction(data);</span><br><span class="line">    <span class="keyword">while</span> (resolves.length) &#123;</span><br><span class="line">      resolves.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add entry modules from loaded chunk to deferred list</span></span><br><span class="line">    deferredModules.push.apply(deferredModules, executeModules || []);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run deferred modules when all chunks ready</span></span><br><span class="line">    <span class="keyword">return</span> checkDeferredModules();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">checkDeferredModules</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; deferredModules.length; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> deferredModule = deferredModules[i];</span><br><span class="line">      <span class="keyword">var</span> fulfilled = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">1</span>; j &lt; deferredModule.length; j++) &#123;</span><br><span class="line">        <span class="keyword">var</span> depId = deferredModule[j];</span><br><span class="line">        <span class="keyword">if</span> (installedChunks[depId] !== <span class="number">0</span>) fulfilled = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (fulfilled) &#123;</span><br><span class="line">        deferredModules.splice(i--, <span class="number">1</span>);</span><br><span class="line">        result = __webpack_require__(</span><br><span class="line">          (__webpack_require__.s = deferredModule[<span class="number">0</span>])</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// script path function</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">jsonpScriptSrc</span>(<span class="params">chunkId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      __webpack_require__.p +</span><br><span class="line">      <span class="string">''</span> +</span><br><span class="line">      (&#123; <span class="attr">lazy</span>: <span class="string">'lazy'</span> &#125;[chunkId] || chunkId) +</span><br><span class="line">      <span class="string">'.js'</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The require function</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This file contains only the entry chunk.</span></span><br><span class="line">  <span class="comment">// The chunk loading function for additional chunks</span></span><br><span class="line">  __webpack_require__.e = <span class="function"><span class="keyword">function</span> <span class="title">requireEnsure</span>(<span class="params">chunkId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> promises = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JSONP chunk loading for javascript</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> installedChunkData = installedChunks[chunkId];</span><br><span class="line">    <span class="keyword">if</span> (installedChunkData !== <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 0 means "already installed".</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// a Promise means "currently loading".</span></span><br><span class="line">      <span class="keyword">if</span> (installedChunkData) &#123;</span><br><span class="line">        promises.push(installedChunkData[<span class="number">2</span>]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// setup Promise in chunk cache</span></span><br><span class="line">        <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">          installedChunkData = installedChunks[chunkId] = [resolve, reject];</span><br><span class="line">        &#125;);</span><br><span class="line">        promises.push((installedChunkData[<span class="number">2</span>] = promise));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// start chunk loading</span></span><br><span class="line">        <span class="keyword">var</span> head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line"></span><br><span class="line">        script.charset = <span class="string">'utf-8'</span>;</span><br><span class="line">        script.timeout = <span class="number">120</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (__webpack_require__.nc) &#123;</span><br><span class="line">          script.setAttribute(<span class="string">'nonce'</span>, __webpack_require__.nc);</span><br><span class="line">        &#125;</span><br><span class="line">        script.src = jsonpScriptSrc(chunkId);</span><br><span class="line">        <span class="keyword">var</span> timeout = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          onScriptComplete(&#123; <span class="attr">type</span>: <span class="string">'timeout'</span>, <span class="attr">target</span>: script &#125;);</span><br><span class="line">        &#125;, <span class="number">120000</span>);</span><br><span class="line">        script.onerror = script.onload = onScriptComplete;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">onScriptComplete</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// avoid mem leaks in IE.</span></span><br><span class="line">          script.onerror = script.onload = <span class="literal">null</span>;</span><br><span class="line">          clearTimeout(timeout);</span><br><span class="line">          <span class="keyword">var</span> chunk = installedChunks[chunkId];</span><br><span class="line">          <span class="keyword">if</span> (chunk !== <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (chunk) &#123;</span><br><span class="line">              <span class="keyword">var</span> errorType =</span><br><span class="line">                event &amp;&amp; (event.type === <span class="string">'load'</span> ? <span class="string">'missing'</span> : event.type);</span><br><span class="line">              <span class="keyword">var</span> realSrc = event &amp;&amp; event.target &amp;&amp; event.target.src;</span><br><span class="line">              <span class="keyword">var</span> error = <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">                <span class="string">'Loading chunk '</span> +</span><br><span class="line">                  chunkId +</span><br><span class="line">                  <span class="string">' failed.\n('</span> +</span><br><span class="line">                  errorType +</span><br><span class="line">                  <span class="string">': '</span> +</span><br><span class="line">                  realSrc +</span><br><span class="line">                  <span class="string">')'</span></span><br><span class="line">              );</span><br><span class="line">              error.type = errorType;</span><br><span class="line">              error.request = realSrc;</span><br><span class="line">              chunk[<span class="number">1</span>](error);</span><br><span class="line">            &#125;</span><br><span class="line">            installedChunks[chunkId] = <span class="literal">undefined</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        head.appendChild(script);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.all(promises);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// The module cache</span></span><br><span class="line">  <span class="keyword">var</span> installedModules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// object to store loaded and loading chunks</span></span><br><span class="line">  <span class="comment">// undefined = chunk not loaded, null = chunk preloaded/prefetched</span></span><br><span class="line">  <span class="comment">// Promise = chunk loading, 0 = chunk loaded</span></span><br><span class="line">  <span class="keyword">var</span> installedChunks = &#123;</span><br><span class="line">    manifest: <span class="number">0</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> deferredModules = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> jsonpArray = (<span class="built_in">window</span>[<span class="string">'webpackJsonp'</span>] = <span class="built_in">window</span>[<span class="string">'webpackJsonp'</span>] || []);</span><br><span class="line">  <span class="keyword">var</span> oldJsonpFunction = jsonpArray.push.bind(jsonpArray);</span><br><span class="line">  jsonpArray.push = webpackJsonpCallback;</span><br><span class="line">  jsonpArray = jsonpArray.slice();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; jsonpArray.length; i++)</span><br><span class="line">    webpackJsonpCallback(jsonpArray[i]);</span><br><span class="line">  <span class="keyword">var</span> parentJsonpFunction = oldJsonpFunction;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// run deferred modules from other chunks</span></span><br><span class="line">  checkDeferredModules();</span><br><span class="line">&#125;)([]);</span><br></pre></td></tr></table></figure></p>
<p>我们先看最下面一段代码:</p>
<ul>
<li>已经加载的模块installedModules={}, 已经加载的chunks installedChunks={}, deferredModules=[]</li>
<li>jsonpArray和window[‘webpackJsonp’]指向了同一个地址；</li>
<li>用oldJsonpFunction存储了原始的数组push方法(在数组末尾添加**)；</li>
<li>重新修改jsonpArray的push方法为webpackJsonpCallback，注意此时window[‘webpackJsonp’]的push方法同时被修改了，因为跟jsonpArray指向的是同一个引用。此时jsonpArray和window[‘webpackJsonp’]为[function push]。即现在指向window[‘webpackJsonp’].push()实际上是在执行webpackJsonpCallback函数。</li>
<li>jsonpArray拷贝了jsonpArray，这里用slice()拷贝，会将方法去掉，即此时jsonpArray为[]</li>
<li>对jsonpArray数组中存储的内容进行处理</li>
<li>用parentJsonpFunction存储原始数组push方法，即parentJsonpFunction(param),就是向window[‘webpackJsonp’]数组尾部添加param</li>
<li>checkDeferredModules</li>
</ul>
<p>然后开始加载main.js<br>main.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(window[&quot;webpackJsonp&quot;] = window[&quot;webpackJsonp&quot;] || []).push([</span><br><span class="line">  [&quot;main&quot;],</span><br><span class="line">  &#123;</span><br><span class="line">    0: function</span><br><span class="line">    ./src/component.js: function</span><br><span class="line">    ./src/index.js: function</span><br><span class="line">    ./src/shake.js: function</span><br><span class="line">    ./src/main.css: function</span><br><span class="line">    ./src/logo2.png: function</span><br><span class="line">    ./node_modules/...:function</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  [[0,&apos;manifest&apos;]]</span><br><span class="line">])</span><br></pre></td></tr></table></figure></p>
<p>这里的push方法实际就是执行webpackJsonpCallback()方法，我们看下这个函数是干什么的：</p>
<ul>
<li>chunkIds=[“main”], moreModules={…} executeModules=[[0, ‘manifest’]]</li>
<li>如果chunkIds里的文件还未加载，则存储到installedChunks中，值为0，标记为已加载</li>
<li>将moreModules内容存储在modules数组上</li>
<li>将所有data数据push到window[‘webpackJsonp’]数组，data=[chunkIds, moreModules, executeModules]</li>
<li>将executeModules数组push到deferredModules</li>
<li>checkDeferredModules</li>
</ul>
<p>继续看checkDeferredModules()方法</p>
<ul>
<li>deferredModule是个二维数组，遍历二维数组中的每一个数组，将其中的数组存储在deferredModule上</li>
<li>从deferredModule的第二项开始遍历，检查是否已经加载，即installedChunks中该模块属性值是否为0</li>
<li>如果都加载了，从deferredModule中删除这项数组，然后调用_wepback_require方法获取deferredModule第一项的输出值,在加载第一项的时候，实际在require moreModules中的模块。</li>
</ul>
<p>我们可以在浏览器中看下component.js,懒加载部分被替换为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">div2.onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> __webpack_require__.e(<span class="comment">/*! import() | lazy */</span> <span class="string">"lazy"</span>).then(__webpack_require__.bind(<span class="literal">null</span>, <span class="comment">/*! ./lazy */</span> <span class="string">"./src/lazy.js"</span>)).then(<span class="function"><span class="keyword">function</span> (<span class="params">lazy</span>) </span>&#123;</span><br><span class="line">     div2.textContent = lazy.default;</span><br><span class="line">   &#125;).catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">     <span class="built_in">console</span>.error(err);</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure></p>
<p>现在点击hello from config的文字，会触发加载Lazy.js bundle文件，看这个e方法：</p>
<ul>
<li>先查看要加载的chunk是否已经加载，已经加载的话，直接返回resolve的promise,如果chunk正在加载中，将该chunk的promise push到promises数组中</li>
<li>如果chunk没有加载，创建一个promise，installedChunkData=installChunks[lazy.js]=[function resolve, function reject, promise], promises=[promise]</li>
<li>在头部创建script，src指向要加载的chunk地址</li>
<li>这时候就会加载bundle lazy.js了，bundle lazy.js文件内容和main.js结构相同，同样的会先执行webpackJsonpCallback, 但是在执行这个函数时，会检查模块是否安装，这里installedChunks中已经有lazy了，所以会将resolve函数push到resolves数组中，然后installedChunks[lazy.js]赋值为0。在做完其他操作后，会执行这个resolve函数，开始webpack require lazy.js文件。</li>
</ul>
<p><code>inline-manifest-webpack-plugin</code>和<code>html-webpack-inline-chunk-plugin</code>,<code>assets-webpack-plugin</code>插件都可以和HtmlWebpackPlugin一起工作，可以将manifest内联到index.html中，从而减少一个请求。<br>通过CDN加载流行的依赖项，比如React，可以进一步改善构建，缩小vendor包大小，如果用户之前点击了CDN，也可以一样缓存下来。<br>我们还可以将manifest抽出为json文件在server rendering的时候很有用。这可以借助一些插件实现：<code>chunk-manifest-webpack-plugin</code>(跟MiniCssExtractPlugin使用有<a href="https://github.com/webpack-contrib/mini-css-extract-plugin/issues/38" target="_blank" rel="noopener">问题</a>),<code>webpack-manifest-plugin</code>,<code>webpack-assets-manifest</code>,<code>webpack-rails-manifest-plugin</code>。</p>
<p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WebpackAssetsManifest = <span class="built_in">require</span>(<span class="string">'webpack-assets-manifest'</span>);</span><br><span class="line">exports.splitManifestJson = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  plugins: [<span class="keyword">new</span> WebpackAssetsManifest()],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>manifest.json<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"lazy.js"</span>: <span class="string">"lazy.2959.js"</span>,</span><br><span class="line">  <span class="attr">"lazy.js.map"</span>: <span class="string">"lazy.2959.js.map"</span>,</span><br><span class="line">  <span class="attr">"logo.png"</span>: <span class="string">"12c2abcaa17626e0afa1fd710c762c17.png"</span>,</span><br><span class="line">  <span class="attr">"logo2.png"</span>: <span class="string">"logo2.b9b9.png"</span>,</span><br><span class="line">  <span class="attr">"main.css"</span>: <span class="string">"styles/main.5b26.css"</span>,</span><br><span class="line">  <span class="attr">"main.js"</span>: <span class="string">"main.e276.js"</span>,</span><br><span class="line">  <span class="attr">"main.js.map"</span>: <span class="string">"main.e276.js.map"</span>,</span><br><span class="line">  <span class="attr">"vendor.js"</span>: <span class="string">"vendor.01ca.js"</span>,</span><br><span class="line">  <span class="attr">"vendor.js.map"</span>: <span class="string">"vendor.01ca.js.map"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Using-Records"><a href="#Using-Records" class="headerlink" title="Using Records"></a>Using Records</h2><p>一些插件比如<code>AggressiveSplittingPlugin</code>使用records实现缓存，我们可以抽出records进一步优化。Records是用来存储分离的编译文件的module IDs。我们需要将其保存为单独的文件，如果本地编译，可以将它纳入版本控制中。<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    recordsPath: path.join(__dirname, <span class="string">"records.json"</span>),</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>编译项目，可以在根目录下找到records.json文件。下次编译的时候，它会更新改变了的文件信息。如果你的代码分隔设置很复杂，并且想确认分隔的部分也获得了正确的缓存行为，Records会变得很重要。最大的问题就是保存recod文件。</p>
<blockquote>
<p>If you change the way webpack handles module IDs (i.e., remove HashedModuleIdsPlugin), possible existing records are still taken into account! If you want to use the new module ID scheme, you have to delete your records file as well.</p>
</blockquote>
<p>现在修改index.js，vendor的hash值就不会再改变了。</p>
<h1 id="Build-Analysis"><a href="#Build-Analysis" class="headerlink" title="Build Analysis"></a>Build Analysis</h1><p>分析编译输出可以更好的了解webpack。可视化分析webpack输出可以帮助你理解你的bundle组合。</p>
<h2 id="Configuring-Webpack"><a href="#Configuring-Webpack" class="headerlink" title="Configuring Webpack"></a>Configuring Webpack</h2><p>为了得到打包的信息，我们需要进行一些配置，<br>package.json<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line"></span><br><span class="line">  "build:stats": "webpack --env production --json &gt; stats.json",</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>运行<code>yarn run build:stats</code>,可以在根目录下找到stats.json文件，通过这个文件可以分析webpack的工作。也可以使用下面的配置：</p>
<ul>
<li>–profile 获取时间相关信息</li>
<li>–progress 展示webpack在各个阶段消耗的时间</li>
</ul>
<p>使用whybundled或者webpack-why可以了解为什么webpack在编译处理阶段包含了某些模块。也可以使用–display-reasons获取更多信息，如<code>npm run build --display-reasons</code></p>
<h2 id="Node-API"><a href="#Node-API" class="headerlink" title="Node API"></a>Node API</h2><p>可以通过node获取stats，stats会包含errors信息，因此可以这样处理错误：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"./webpack.config.js"</span>)(<span class="string">"production"</span>);</span><br><span class="line"></span><br><span class="line">webpack(config, (err, stats) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stats.hasErrors()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">console</span>.error(stats.toString(<span class="string">"errors-only"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(stats);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>如果希望获得stats的JSON输出格式，使用stats.toJson()。需要verbose输出，使用stats.toJson(“verbose”);<br>使用<code>console.log(JSON.stringify(stats.toJson(), null, 2))</code>,输出的信息更具可读性。</p>
<h3 id="StatsWebpackPlugin-and-WebpackStatsPlugin"><a href="#StatsWebpackPlugin-and-WebpackStatsPlugin" class="headerlink" title="StatsWebpackPlugin and WebpackStatsPlugin"></a>StatsWebpackPlugin and WebpackStatsPlugin</h3><p>如果想通过插件管理stats，可以使用stats-webpack-plugin或者webpack-stats-plugin。</p>
<h2 id="Enabling-a-Performance-Budget"><a href="#Enabling-a-Performance-Budget" class="headerlink" title="Enabling a Performance Budget"></a>Enabling a Performance Budget</h2><p>通过webpack可以定义性能阈值。你可以提供编译size限制，默认情况下禁用该特性，如果没有达到阈值并且配置为未达到阈值时生成error，它将终止整个构建过程。</p>
<p>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    performance: &#123;</span><br><span class="line">      hints: <span class="string">"warning"</span>, <span class="comment">// "error" or false are valid too</span></span><br><span class="line">      maxEntrypointSize: <span class="number">50000</span>, <span class="comment">// in bytes, default 250k</span></span><br><span class="line">      maxAssetSize: <span class="number">450000</span>, <span class="comment">// in bytes</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>在我们的示例中<code>yarn run build</code>，可以得到下面的warning:<br><img src="/2018/05/04/surviveJS-webpack-optimizing/warning.png" alt=""></p>
<p>你可以增大限制或者移除配置来解除警告，或者可以参考<a href="https://survivejs.com/webpack/techniques/consuming/" target="_blank" rel="noopener">Consuming packages</a>中的方法替换React.</p>
<h2 id="Available-Analysis-Tools"><a href="#Available-Analysis-Tools" class="headerlink" title="Available Analysis Tools"></a><a href="https://survivejs.com/webpack/optimizing/build-analysis/#available-analysis-tools" target="_blank" rel="noopener">Available Analysis Tools</a></h2><h1 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h1><h2 id="Measuring-Impact"><a href="#Measuring-Impact" class="headerlink" title="Measuring Impact"></a>Measuring Impact</h2><p>两种方法来测试构建时间：</p>
<ul>
<li>生成stats分析</li>
<li>speed-measure-webpack-plugin 可以查看每个plugin和loader的构建时间</li>
</ul>
<h2 id="High-Level-Optimizations"><a href="#High-Level-Optimizations" class="headerlink" title="High-Level Optimizations"></a>High-Level Optimizations</h2><p>webpack默认只有一个实例，这样就不能充分利用多核电脑的好处。因此出现了一些第三方解决方案：parallel-webpack和Happypack.</p>
<h3 id="parallel-webpack-Run-Multiple-Webpack-Instances-in-Parallel"><a href="#parallel-webpack-Run-Multiple-Webpack-Instances-in-Parallel" class="headerlink" title="parallel-webpack - Run Multiple Webpack Instances in Parallel"></a>parallel-webpack - Run Multiple Webpack Instances in Parallel</h3><p>parallel-webpack 可以用两种方式来并行webpack配置。</p>
<ul>
<li>如果你的webpack配置定义为一个数组，他可以并行运行webpack配置</li>
<li>根据定义的variants构建，使用variants可以并行打包生产和开发环境。variants也可以允许你生成不同targets的bundle，parallel-webpack底层依赖worker-farm，可以将parallel-webpack安装为devdependency，然后将webpack命令替换为Parallel-webpack.</li>
</ul>
<h3 id="HappyPack-File-Level-Parallelism"><a href="#HappyPack-File-Level-Parallelism" class="headerlink" title="HappyPack - File Level Parallelism"></a>HappyPack - File Level Parallelism</h3><p>在整个 Webpack 构建流程中，最耗时的流程可能就是 Loader 对文件的转换操作了，因为要转换的文件数据巨多，而且这些转换操作都只能一个个挨着处理。 HappyPack 的核心原理就是把这部分任务分解到多个进程去并行处理，从而减少了总的构建时间。所有需要通过 Loader 处理的文件都先交给了 happypack/loader 去处理，收集到了这些文件的处理权后 HappyPack 就好统一分配了。每通过 new HappyPack() 实例化一个 HappyPack 其实就是告诉 HappyPack 核心调度器如何通过一系列 Loader 去转换一类文件，并且可以指定如何给这类转换操作分配子进程。核心调度器的逻辑代码在主进程中，也就是运行着 Webpack 的进程中，核心调度器会把一个个任务分配给当前空闲的子进程，子进程处理完毕后把结果发送给核心调度器，它们之间的数据交换是通过进程间通信 API 实现的。核心调度器收到来自子进程处理完毕的结果后会通知 Webpack 该文件处理完毕。</p>
<h2 id="Low-Level-Optimizations"><a href="#Low-Level-Optimizations" class="headerlink" title="Low-Level Optimizations"></a>Low-Level Optimizations</h2><ul>
<li>开发环境下使用更快速的source map或者不配置source map。</li>
<li>开发环境下可以使用babel-preset-env来替代source maps，对于现代浏览器转换部分特性，使得代码更加可读，更方便debug。</li>
<li>开发环境下不使用polyfills。</li>
<li>开发环境下可以将不需要的部分disable掉，只编译你需要的那部分，这样打包更小。</li>
<li>Polyfill less of Node and provide nothing instead. For example, a package could use Node process which in turn will bloat your bundle. To disable it, set node.process to false. To disable polyfilling entirely, set node to false directly. See <a href="https://webpack.js.org/configuration/node/" target="_blank" rel="noopener">webpack documentation</a> for the default values.</li>
<li>对不经常改动的bundles使用Dynamically Loaded Libraries (DLL) ，可以参考<a href="https://robertknight.me.uk/posts/webpack-dll-plugins/" target="_blank" rel="noopener">Rob Knight’s blog</a>。autodll-webpack-plugin可以自动处理这个过程。</li>
</ul>
<h3 id="Plugin-Specific-Optimizations"><a href="#Plugin-Specific-Optimizations" class="headerlink" title="Plugin Specific Optimizations"></a>Plugin Specific Optimizations</h3><ul>
<li>借助一些plugins来利用缓存，比如hard-source-webpack-plugin，可以减少部分不必要的工作</li>
<li>开发环境使用功能相似但更轻巧的插件或者loader，比如可以用HtmlPlugin来替换HtmlWebpackPlugin</li>
</ul>
<h3 id="Loader-Specific-Optimizations"><a href="#Loader-Specific-Optimizations" class="headerlink" title="Loader Specific Optimizations"></a>Loader Specific Optimizations</h3><ul>
<li>开发环境下可以通过跳过一些loaders来减少部分处理过程。如果你使用现代浏览器开发，就可以不使用babel-loader或者相似的loader。</li>
<li>对于一些loaders使用include或者exclude注明使用范围。</li>
<li>对于转换比较复杂的Loaders可以使用cache-loader缓存结果到硬盘（比如图片操作）。还可以使用thread-loader，来平行处理，当并行工作很繁重的时候可以考虑使用thread-loader.</li>
</ul>
<h2 id="Optimizing-Rebundling-Speed-During-Development"><a href="#Optimizing-Rebundling-Speed-During-Development" class="headerlink" title="Optimizing Rebundling Speed During Development"></a>Optimizing Rebundling Speed During Development</h2><p>开发环境下使用Minified版本库，比如react，可以优化重新编译时间。如果速度很重要的话，可以不使用propType校验。<br>module.noParse接受一个正则表达式或者一个正则表达式数组。它可以告诉webpack不要解析你想要使用的minified文件，同时你需要对react使用resolve.alias。<br>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">exports.dontParse = <span class="function">(<span class="params">&#123; name, path &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> alias = &#123;&#125;;</span><br><span class="line">  alias[name] = path;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">      noParse: [<span class="keyword">new</span> <span class="built_in">RegExp</span>(path)],</span><br><span class="line">    &#125;,</span><br><span class="line">    resolve: &#123;</span><br><span class="line">      alias,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dontParse(&#123;</span><br><span class="line">  name: <span class="string">"react"</span>,</span><br><span class="line">  path: path.resolve(</span><br><span class="line">    __dirname, <span class="string">"node_modules/react/cjs/react.production.min.js"</span>,</span><br><span class="line">  ),</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure></p>
<p>这样修改后，项目重新编译时应该会更快，这个技巧也可以用在生产环境。因为module.noParse接受正则表达式，所以如果你想要忽略所有的*.min.js文件，需要设置为<code>/\.min\.js/</code>。<br>Note:不是所有的模块都支持module.noParse。他们不能有require, define或者类似的引用，这样会导致<code>Uncaught ReferenceError: require is not defined error</code>。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/02/surviveJS-webpack-building/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/02/surviveJS-webpack-building/" itemprop="url">surviveJS-webpack-building 学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-02T19:10:56+08:00">2018-05-02</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/02/surviveJS-webpack-building/" class="leancloud_visitors" data-flag-title="surviveJS-webpack-building 学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><a href="https://survivejs.com/webpack/building/" target="_blank" rel="noopener">surviveJS-webpack-building</a></strong></p>
<h1 id="Source-Maps"><a href="#Source-Maps" class="headerlink" title="Source Maps"></a>Source Maps</h1><p>如果在浏览器打开网页调试，我们会看到打包后的代码，当出现问题的时候，我们怎么定位到原始的代码中呢。这个时候就需要借助source maps，它提供原始代码和打包后的代码之间的映射，不仅可以映射JS，也可以用于CSS。</p>
<p>webpack 4中当mode为development时，会自动为你开启source maps。</p>
<h2 id="Enabling-source-maps"><a href="#Enabling-source-maps" class="headerlink" title="Enabling source maps"></a>Enabling source maps</h2><p>webpack提供两种开启source map的方法：使用devtool配置字段；或者使用插件来提供更多控制。除了webpack需要配置，还需要开启你开发所在浏览器的source map功能。</p>
<h3 id="Enabling-source-maps-in-webpack"><a href="#Enabling-source-maps-in-webpack" class="headerlink" title="Enabling source maps in webpack"></a>Enabling source maps in webpack</h3><p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exports.generateSourceMaps = <span class="function">(<span class="params">&#123; type &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  devtool: type,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>webpack支持多种source map类型，这些source map主要是在性能和编译速度上不一样。我们可以在生产环境使用<code>source-map</code>，在开发环境使用webpack提供的默认选项。因此可以这样设置：<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line"></span><br><span class="line">  parts.generateSourceMaps(&#123; <span class="attr">type</span>: <span class="string">"source-map"</span> &#125;),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p><code>source-map</code>是编译最慢但是性能最好的一种source map类型，但是用在生产环境也是一种不错的选择。</p>
<p><code>yarn run prod</code>看下控制台的输出：<br><img src="/2018/05/02/surviveJS-webpack-building/source-map.png" alt=""><br>可以看一下.map的文件，里面存放的就是源代码和打包后代码的映射。在开发环境下，这些映射信息写在bundle中。</p>
<h3 id="Enabling-source-maps-in-browsers"><a href="#Enabling-source-maps-in-browsers" class="headerlink" title="Enabling source maps in browsers"></a>Enabling source maps in browsers</h3><p><a href="https://developers.google.com/web/tools/chrome-devtools/" target="_blank" rel="noopener">chrome</a> 调试方法。<br>其他浏览器可以自行谷歌。</p>
<h2 id="Source-map-types-supported-by-webpack"><a href="#Source-map-types-supported-by-webpack" class="headerlink" title="Source map types supported by webpack"></a>Source map types supported by webpack</h2><p>webpack提供了内联source map和分离的source map。</p>
<ul>
<li>inline 内联source map将映射数据直接存放在打包后的文件中。</li>
<li>separate 分离source map将映射数据存放在单独的文件中，使用注释链接源代码</li>
</ul>
<p>inline source map编译速度快，适合于开发环境，但因为内联的方式，会增大bundle的体积。因此在生产环境中适合使用separate source map。</p>
<h3 id="inline-source-maps"><a href="#inline-source-maps" class="headerlink" title="inline source maps"></a>inline source maps</h3><p>webpack提供了多种内联source map，一般都包含‘eval’, 其中<code>cheap-module-eval-source-map</code>在chrome和firefox上都很稳定，并且在速度和性能上也都不错。<br>下面列出了webpack提供的inline source map，并且都有示例。源代码中只有一句<code>console.log(&#39;hello world&#39;)</code>,并且使用了<code>webpack.NamedModulesPlugin</code>来帮助理解。<a href="https://survivejs.com/webpack/building/source-maps/" target="_blank" rel="noopener">示例原文</a></p>
<h4 id="devtool-“eval”"><a href="#devtool-“eval”" class="headerlink" title="devtool: “eval”"></a>devtool: “eval”</h4><p>每个模块都使用 eval() 执行，并且都有 //@ sourceURL。此选项会非常快地构建。主要缺点是，由于会映射到转换后的代码，而不是映射到原始代码（没有从 loader 中获取 source map），所以不能正确的显示行数。</p>
<h4 id="devtool-“cheap-eval-source-map”"><a href="#devtool-“cheap-eval-source-map”" class="headerlink" title="devtool: “cheap-eval-source-map”"></a>devtool: “cheap-eval-source-map”</h4><p>类似 eval-source-map，每个模块使用 eval() 执行。这是 “cheap(低开销)” 的 source map，因为它没有生成列映射(column mapping)，只是映射行数。它会忽略源自 loader 的 source map，并且仅显示转译后的代码，就像 eval devtool。</p>
<h4 id="devtool-“cheap-module-eval-source-map”"><a href="#devtool-“cheap-module-eval-source-map”" class="headerlink" title="devtool: “cheap-module-eval-source-map”"></a>devtool: “cheap-module-eval-source-map”</h4><p>类似 cheap-eval-source-map，并且，在这种情况下，源自 loader 的 source map 会得到更好的处理结果。然而，loader source map 会被简化为每行一个映射(mapping)。</p>
<h4 id="devtool-“eval-source-map”"><a href="#devtool-“eval-source-map”" class="headerlink" title="devtool: “eval-source-map”"></a>devtool: “eval-source-map”</h4><p> 每个模块使用 eval() 执行，并且 source map 转换为 DataUrl 后添加到 eval() 中。初始化 source map 时比较慢，但是会在重新构建时提供比较快的速度，并且生成实际的文件。行数能够正确映射，因为会映射到原始代码中。它会生成用于开发环境的最佳品质的 source map。</p>
<h3 id="separate-source-maps"><a href="#separate-source-maps" class="headerlink" title="separate source maps"></a>separate source maps</h3><p>分离的source map会将映射关系存放在以.map为扩展名的文件中，需要时才会被浏览器加载。</p>
<h4 id="devtool-“cheap-source-map”"><a href="#devtool-“cheap-source-map”" class="headerlink" title="devtool: “cheap-source-map”"></a>devtool: “cheap-source-map”</h4><p><code>cheap-source-map</code>和上面那些带cheap的选项一样，不会从loader中获取source map，比如css-loader的source map。</p>
<h4 id="devtool-“cheap-module-source-map”"><a href="#devtool-“cheap-module-source-map”" class="headerlink" title="devtool: “cheap-module-source-map”"></a>devtool: “cheap-module-source-map”</h4><p><code>cheap-module-source-map</code>和<code>cheap-source-map</code>相似，但是包含loaders的source map。</p>
<h4 id="devtool-“hidden-source-map”"><a href="#devtool-“hidden-source-map”" class="headerlink" title="devtool: “hidden-source-map”"></a>devtool: “hidden-source-map”</h4><p>与 source-map 相同，但不会为 bundle 添加引用注释。如果你只想 source map 映射那些源自错误报告的错误堆栈跟踪信息，但不想为浏览器开发工具暴露你的 source map，这个选项会很有用。</p>
<h4 id="devtool-“nosources-source-map”"><a href="#devtool-“nosources-source-map”" class="headerlink" title="devtool: “nosources-source-map”"></a>devtool: “nosources-source-map”</h4><p>和source-map相似，但是不会在源文件中写入source maps的引用。如果你不想直接在开发者工具中暴露source maps，只需要stack traces，可以使用这种方式。</p>
<h4 id="devtool-“source-map”"><a href="#devtool-“source-map”" class="headerlink" title="devtool: “source-map”"></a>devtool: “source-map”</h4><p> 整个 source map 作为一个单独的文件生成。它为 bundle 添加了一个引用注释，以便开发工具知道在哪里可以找到它。<code>source-map</code>构建速度慢，但是性能很好。如果你不在意生产环境的source maps，也可以不设置source map。</p>
<p>下面<a href="https://www.webpackjs.com/configuration/devtool/" target="_blank" rel="noopener">这张图</a>对比了这些source maps;<br><img src="/2018/05/02/surviveJS-webpack-building/sourcemaptypes.png" alt=""></p>
<h3 id="other-source-map-options"><a href="#other-source-map-options" class="headerlink" title="other source map options"></a>other source map options</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  output: &#123;</span><br><span class="line">    <span class="comment">// Modify the name of the generated source map file.</span></span><br><span class="line">    <span class="comment">// You can use [file], [id], and [hash] replacements here.</span></span><br><span class="line">    <span class="comment">// The default option is enough for most use cases.</span></span><br><span class="line">    sourceMapFilename: <span class="string">'[file].map'</span>, <span class="comment">// Default</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is the source map filename template. It's default</span></span><br><span class="line">    <span class="comment">// format depends on the devtool option used. You don't</span></span><br><span class="line">    <span class="comment">// need to modify this often.</span></span><br><span class="line">    devtoolModuleFilenameTemplate:</span><br><span class="line">      <span class="string">'webpack:///[resource-path]?[loaders]'</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用了UglifyJsPlugin，同时还需要source maps，需要在这个插件中使用<code>sourceMap:true</code>开启source map。因为UglifyJS对源代码做了进一步转换，会破坏映射。对于其他一些plugins和loaders也是一样的，比如css-loader.</p>
<h2 id="SourceMapDevToolPlugin-and-EvalSourceMapDevToolPlugin"><a href="#SourceMapDevToolPlugin-and-EvalSourceMapDevToolPlugin" class="headerlink" title="SourceMapDevToolPlugin and EvalSourceMapDevToolPlugin"></a>SourceMapDevToolPlugin and EvalSourceMapDevToolPlugin</h2><p>  如果对生成的source map需要更多的控制，可以使用<code>SourceMapDevToolPlugin</code>或者<code>EvalSourceMapDevToolPlugin</code>。后者主要控制跟eval相关的source map。两个插件都可以更细粒度的控制source map，使用这些插件可以跳过对devtool的设置。<br>比如，webpack默认只会对.js和.css文件生成source maps，<code>SourceMapDevToolPlugin</code>可以接受一个正则如/.(js|jsx|css)($|\?)/i，这样就可以允许对其他扩展名的文件也生成source map了。<br><code>EvalSourceMapDevToolPlugin</code>可以看成是<code>devtool:&quot;eval&quot;</code>的别名，同时能提供更灵活的控制。</p>
<h2 id="Source-Maps-for-Styling"><a href="#Source-Maps-for-Styling" class="headerlink" title="Source Maps for Styling"></a>Source Maps for Styling</h2><p>如果希望获得样式文件的source maps，可以开启sourceMap选项，如css-loader, sass-loader, less-loader。<br>当imports中使用相对路径时，css-loader会有一些<a href="https://github.com/webpack-contrib/css-loader/issues/232" target="_blank" rel="noopener">问题</a>，可以通过设置<code>output.publicPath</code>指向服务器url解决。</p>
<h2 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h2><ul>
<li><code>devtool: &quot;source-map&quot;</code>映射质量最高，适于生产环境使用。</li>
<li><code>cheap-module-eval-source-map</code>适合用于开发环境。</li>
<li>如果生产环境中只需要stack traces，可以用<code>devtool: &quot;hidden-source-map&quot;</code>。可以捕获输出并利用第三方服务测试并解决问题。</li>
<li><code>SourceMapDevToolPlugin</code>和<code>EvalSourceMapDevToolPlugin</code>对source map 提供了更细粒度的控制。</li>
<li><code>source-map-loader</code> can come in handy if your dependencies provide source maps.</li>
<li>开启样式的source maps需要对你使用的每个样式相关的loader设置sourceMap选项</li>
</ul>
<h1 id="Bundle-spliting"><a href="#Bundle-spliting" class="headerlink" title="Bundle spliting"></a>Bundle spliting</h1><p>到目前为止，我们示例的生产环境下的代码都打包到了一个JS文件中。如果稍微改变一下应用代码，浏览器就需要下载整个bundle。如果能只下载改变的部分就好了，比如vendor dependencies改变了，浏览器只需要下载vendor dependencies。如果是实际应用代码改变了，就只需要下载应用代码。<br>我们可以通过<code>optimization.splitChunks.cacheGroups</code>分隔bundle。在webpack4中，mode为production时会自动执行一些分隔。</p>
<h2 id="The-idea-of-bundling-spliting"><a href="#The-idea-of-bundling-spliting" class="headerlink" title="The idea of bundling spliting"></a>The idea of bundling spliting</h2><p>分隔bundle，可以将vendor依赖单独打包，并能利用客户端进行缓存。分隔bundle后，整个应用的bundle总体积不会变大，但是会增加请求数量。比如，main.js(100 kB), 分隔后main.js(10 kB)和vendor.js(90 kB)。现在修改应用代码，浏览器就只需要下载main.js(10 kB)就可以了。<br>当然缓存也会带来一些问题，比如缓存失效，这个问题可以参考<a href="https://survivejs.com/webpack/optimizing/adding-hashes-to-filenames/" target="_blank" rel="noopener">原文</a>解决.</p>
<h2 id="Adding-something-to-split"><a href="#Adding-something-to-split" class="headerlink" title="Adding something to split"></a>Adding something to split</h2><p>我们现在的示例中，还没有什么可以分离到vendor中的，我们首先给这个例子添加一些依赖，比如react:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add react react-dom</span><br></pre></td></tr></table></figure></p>
<p>src/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"react-dom"</span>;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn run build</span><br></pre></td></tr></table></figure>
<p><img src="/2018/05/02/surviveJS-webpack-building/bundle1.png" alt=""><br>可以看到main.js现在很大。</p>
<h2 id="Setting-Up-a-vendor-Bundle"><a href="#Setting-Up-a-vendor-Bundle" class="headerlink" title="Setting Up a vendor Bundle"></a>Setting Up a vendor Bundle</h2><p>webpack4之前，一般会使用<code>CommonsChunkPlugin</code>来分隔bundle。在webpack4中这个插件替换成了配置项。从node_modules文件夹下抽出vendor bundle可以如下配置：<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    optimization: &#123;</span><br><span class="line">      splitChunks: &#123;</span><br><span class="line">        chunks: <span class="string">"initial"</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>现在编译一下可以看到main.js已经变得很小了。<br><img src="/2018/05/02/surviveJS-webpack-building/bundle2.png" alt=""></p>
<h2 id="Controlling-Bundle-Splitting"><a href="#Controlling-Bundle-Splitting" class="headerlink" title="Controlling Bundle Splitting"></a>Controlling Bundle Splitting</h2><p>还可以用一种更明确的方式来配置，指定将node_modules中的依赖抽成vendor：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    optimization: &#123;</span><br><span class="line">      splitChunks: &#123;</span><br><span class="line">        cacheGroups: &#123;</span><br><span class="line">          commons: &#123;</span><br><span class="line">            test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">            name: <span class="string">"vendor"</span>,</span><br><span class="line">            chunks: <span class="string">"initial"</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>如果你不喜欢默认的配置，可以用这种形式更好的控制分隔过程。</p>
<h2 id="Splitting-and-Merging-Chunks"><a href="#Splitting-and-Merging-Chunks" class="headerlink" title="Splitting and Merging Chunks"></a>Splitting and Merging Chunks</h2><p><code>AggressiveSplittingPlugin</code>和<code>AggressiveMergingPlugin</code>插件可以控制生成的chunks。第一个插件可以控制生成更多更小的bundles。<br>下面是一个简单的aggressive splitting例子：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.AggressiveSplittingPlugin(&#123;</span><br><span class="line">        minSize: <span class="number">10000</span>,</span><br><span class="line">        maxSize: <span class="number">30000</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>如果拆分成更多小bundles，会丢失缓存，并且在http/1环境下造成更多请求开销。当项目中使用了<code>HtmlWebpackPlugin</code>时，这个方法好像会不起作用，html中没有任何script，可以看这个<a href="https://github.com/jantimon/html-webpack-plugin/issues/446" target="_blank" rel="noopener">issue</a>。<br><code>AggressiveMergingPlugin</code>功能相反，用来将小的bundles合成大的bundle。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> AggressiveMergingPlugin(&#123;</span><br><span class="line">        minSizeReduce: <span class="number">2</span>,</span><br><span class="line">        moveToParents: <span class="literal">true</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>如果使用webpack records,会得到很好的缓存效果。<br><code>webpack.optimize</code>包括<code>LimitChunkCountPlugin</code>和<code>MinChunkSizePlugin</code>可以更好的控制chunk大小。</p>
<h2 id="Chunk-Types-in-Webpack"><a href="#Chunk-Types-in-Webpack" class="headerlink" title="Chunk Types in Webpack"></a>Chunk Types in Webpack</h2><p>在上面的示例中，我们用了不同类型的webpack chunks。webpack的chunks分为下面三类：</p>
<ul>
<li>Entry chunks, 包含webpack的runtime和加载的modules</li>
<li>Normal chunks，不包括webpack runtime。相反，这些chunks可以在应用程序运行时动态加载。为此生成了一些包装器，比如JSONP。</li>
<li>Initial chunks, Initial chunks are normal chunks that count towards initial loading time of the application. As a user, you don’t have to care about these. It’s the split between entry chunks and normal chunks that is important.</li>
</ul>
<h2 id="conclusion-1"><a href="#conclusion-1" class="headerlink" title="conclusion"></a>conclusion</h2><p>通过配置<code>optimization.splitChunks.cacheGroups</code>可以分割bundles。webpack 4中mode 为 production时，会默认split bundles。<br>vendor bundle包含了项目中的第三方库，可以通过检查导入模块的位置来分析vendor依赖。<br>AggressiveSplittingPlugin and AggressiveMergingPlugin插件可以更好的控制chunk。<br>webpack内部依赖三种chunk类型：entry, normal, initial chunks。</p>
<h1 id="Code-Spliting"><a href="#Code-Spliting" class="headerlink" title="Code Spliting"></a>Code Spliting</h1><p>应用程序加载时间越长，用户体验就越差，在移动端这个问题会更明显。虽然我们已经使用了bundle split来缓解，但仍然需要下载大量数据，下面我们将体验code split，它允许懒加载代码。当用户进入新的视图时，加载这个视图的代码，或者将加载绑定在特定的操作上，比如滚动或者单击按钮，还可以预测用户下一步的行为，这样当用户进行下一步行为时，这个功能代码已经加载好了。这样就不需要在打开页面的时候一次性加载所有的代码，造成应用程序加载时间很长。</p>
<h2 id="Code-Splitting-Formats"><a href="#Code-Splitting-Formats" class="headerlink" title="Code Splitting Formats"></a>Code Splitting Formats</h2><p>webpack 提供了两种代码分隔的方法。对于动态导入，第一种，也是优先选择的方式是，使用符合 ECMAScript 提案 的 import() 语法。第二种，则是使用 webpack 特定的 require.ensure。</p>
<h3 id="Dynamic-import"><a href="#Dynamic-import" class="headerlink" title="Dynamic import"></a>Dynamic import</h3><p>import() 调用会在内部用到 promises。如果在旧版本浏览器中使用 import()，记得使用 一个 polyfill 库（例如 es6-promise 或 promise-polyfill），来 shim Promise。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "optional-name" */</span> <span class="string">"./module"</span>).then(</span><br><span class="line">  <span class="built_in">module</span> =&gt; &#123;...&#125;</span><br><span class="line">).catch(</span><br><span class="line">  error =&gt; &#123;...&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>设置optional-name可以将具有相同那么的多个分隔点放入一个单独的bundle中。默认情况下每个分隔点都会生成单独的bundle.<br>import还可以组合使用，实现平行加载多个资源：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all([</span><br><span class="line">  <span class="keyword">import</span>(<span class="string">"lunr"</span>),</span><br><span class="line">  <span class="keyword">import</span>(<span class="string">"../search_index.json"</span>),</span><br><span class="line">]).then(<span class="function">(<span class="params">[lunr, search]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    index: lunr.Index.load(search.index),</span><br><span class="line">    lines: search.lines,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>由于 import() 会返回一个 promise，因此它可以和 async 函数一起使用。但是，需要使用像 Babel 这样的预处理器和<a href="https://babeljs.io/docs/plugins/syntax-dynamic-import/#installation" target="_blank" rel="noopener">Syntax Dynamic Import Babel Plugin</a>。</p>
<h2 id="Setting-Up-Code-Splitting"><a href="#Setting-Up-Code-Splitting" class="headerlink" title="Setting Up Code Splitting"></a>Setting Up Code Splitting</h2><p>为了使动态引入起作用，我们还需要配置一下babel.</p>
<h3 id="Configuring-Babel"><a href="#Configuring-Babel" class="headerlink" title="Configuring Babel"></a>Configuring Babel</h3><p>Babel不支持动态导入的语法，因此需要<code>babel-plugin-syntax-dynamic-import</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add babel-plugin-syntax-dynamic-import -D</span><br></pre></td></tr></table></figure></p>
<p>.babelrc<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">"plugins"</span>: [<span class="string">"syntax-dynamic-import"</span>],</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>If you are using ESLint, you should install babel-eslint and set parser: “babel-eslint” in addition to parserOptions.allowImportExportEverywhere: true at ESLint configuration.</p>
</blockquote>
<h3 id="Defining-a-Split-Point-Using-a-Dynamic-import"><a href="#Defining-a-Split-Point-Using-a-Dynamic-import" class="headerlink" title="Defining a Split Point Using a Dynamic import"></a>Defining a Split Point Using a Dynamic import</h3><p>我们先定义一个需要懒加载的文件，然后将加载操作绑定在按钮点击上，点击按钮加载文件内容，覆盖原始button内容。<br>src/lazy.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="string">"Hello from lazy"</span>;</span><br></pre></td></tr></table></figure></p>
<p>src/component.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (text = <span class="string">"Hello world"</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> element = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line"></span><br><span class="line">  element.className = <span class="string">"pure-button"</span>;</span><br><span class="line">  element.innerHTML = text;</span><br><span class="line"></span><br><span class="line">  element.onclick = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "lazy" */</span><span class="string">"./lazy"</span>)</span><br><span class="line">      .then(<span class="function"><span class="params">lazy</span> =&gt;</span> &#123;</span><br><span class="line">        element.textContent = lazy.default;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>运行代码，当点击div时，会看到network里请求了lazy.js。如果希望统一调整生成的chunk名字，可以设置<code>output.chunkFilename</code>,如设置为chunk.[id].js，lazy.js就会打包为chunk.0.js.<br>我们再<code>yarn run prod</code>看下打包的文件：<br><img src="/2018/05/02/surviveJS-webpack-building/codesplit.png" alt=""><br>我们可以看一下生成的lazy.js中的内容，webpack用webpackJsonp将源代码包裹了起来。<br><img src="/2018/05/02/surviveJS-webpack-building/codesplit2.png" alt=""></p>
<h2 id="Code-Splitting-in-React"><a href="#Code-Splitting-in-React" class="headerlink" title="Code Splitting in React"></a>Code Splitting in React</h2><p>我们也可以在react 组件中使用动态引入。相关loader：<a href="https://www.npmjs.com/package/react-async-component" target="_blank" rel="noopener">react-async-component</a>,<a href="https://www.npmjs.com/package/loadable-components" target="_blank" rel="noopener">loadable-components</a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Somewhere in code</span></span><br><span class="line">&lt;AsyncComponent loader=&#123;() =&gt; <span class="keyword">import</span>(<span class="string">"./SomeComponent"</span>)&#125; /&gt;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.state = &#123; <span class="attr">Component</span>: <span class="literal">null</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.props.loader().then(</span><br><span class="line">      Component =&gt; <span class="keyword">this</span>.setState(&#123; Component &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; Component &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123; Placeholder, ...props &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Component ? <span class="xml"><span class="tag">&lt;<span class="name">Component</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span> : <span class="tag">&lt;<span class="name">Placeholder</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml">AsyncComponent.propTypes = &#123;</span></span><br><span class="line"><span class="xml">  loader: PropTypes.func.isRequired,</span></span><br><span class="line"><span class="xml">  Placeholder: PropTypes.node.isRequired,</span></span><br><span class="line"><span class="xml">&#125;;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Disabling-Code-Splitting"><a href="#Disabling-Code-Splitting" class="headerlink" title="Disabling Code Splitting"></a>Disabling Code Splitting</h2><p>虽然代码分隔是个很好的方法，但并不总是正确的，尤其是在服务端使用时。我们可以这样通过下面的方式禁用：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.LimitChunkCountPlugin(&#123;</span><br><span class="line">      maxChunks: <span class="number">1</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="conclusion-2"><a href="#conclusion-2" class="headerlink" title="conclusion"></a>conclusion</h2><p>代码分隔可以实现按需加载，从而缩短首屏渲染时间，提升用户体验。</p>
<ul>
<li>使用动态引入语法时，还需要配置babel和eslint。webpack默认支持该语法。</li>
<li>动态引入时，加入命名，可以将相同名称的分隔代码放在一个bundle中。</li>
<li>配置<code>webpack.optimize.LimitChunkCountPlugin</code>的<code>maxChunks</code>可以禁用代码分隔</li>
<li>动态引入也可以用在一些主流的框架中，比如react。你可以把相关逻辑封装到一个组件中，以对用户友好的方式处理加载过程。</li>
</ul>
<h1 id="Tidying-Up"><a href="#Tidying-Up" class="headerlink" title="Tidying Up"></a>Tidying Up</h1><p>我们的示例下的dist目录里面积压了很多次build产生的文件，非常的混乱，可以考虑在每次编译时清理前一次编译生成的文件。我们还可以把每次的编译信息比如版本信息，作为注释放在编译文件的顶部，</p>
<h2 id="Cleaning-the-Build-Directory"><a href="#Cleaning-the-Build-Directory" class="headerlink" title="Cleaning the Build Directory"></a>Cleaning the Build Directory</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add clean-webpack-plugin -D</span><br></pre></td></tr></table></figure>
<p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CleanWebpackPlugin = <span class="built_in">require</span>(<span class="string">"clean-webpack-plugin"</span>);</span><br><span class="line"></span><br><span class="line">exports.clean = <span class="function"><span class="params">path</span> =&gt;</span> (&#123;</span><br><span class="line">  plugins: [<span class="keyword">new</span> CleanWebpackPlugin([path])],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PATHS = &#123;</span><br><span class="line">  app: path.join(__dirname, <span class="string">"src"</span>),</span><br><span class="line"></span><br><span class="line">  build: path.join(__dirname, <span class="string">"dist"</span>),</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line"></span><br><span class="line">  parts.clean(PATHS.build),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>这样配置后，在每次编译的时候，都会清空build目录下的文件。</p>
<h2 id="Attaching-a-Revision-to-the-Build"><a href="#Attaching-a-Revision-to-the-Build" class="headerlink" title="Attaching a Revision to the Build"></a>Attaching a Revision to the Build</h2><p>将与当前编译相关的信息加入到编译生成的文件中，可以方便debug。可以使用<code>webpack.BannerPlugin</code>来实现，如果结合<code>git-revision-webpack-plugin</code>使用可以将版本信息作为注释放在文件顶部。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add git-revision-webpack-plugin -D</span><br></pre></td></tr></table></figure></p>
<p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"><span class="keyword">const</span> GitRevisionPlugin = <span class="built_in">require</span>(<span class="string">"git-revision-webpack-plugin"</span>);</span><br><span class="line"></span><br><span class="line">exports.attachRevision = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.BannerPlugin(&#123;</span><br><span class="line">      banner: <span class="keyword">new</span> GitRevisionPlugin().version(),</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parts.attachRevision(),</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>编译后可以看到生成的文件头部都有注释相关编译信息。可以通过修改banner内容修改注释信息，也可以将revision信息传给<code>webpack.DefinePlugin</code>。</p>
<h2 id="Copying-files"><a href="#Copying-files" class="headerlink" title="Copying files"></a>Copying files</h2><blockquote>
<p>Copying files is another ordinary operation you can handle with webpack. <code>copy-webpack-plugin</code> can be handy if you need to bring external data to your build without having webpack pointing at them directly.</p>
</blockquote>
<blockquote>
<p><code>cpy-cli</code> is a good option if you want to copy outside of webpack in a cross-platform way. Plugins should be cross-platforms by definition.</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/12/responsive-image/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/12/responsive-image/" itemprop="url">responsive images</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-12T19:24:34+08:00">2018-04-12</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/12/responsive-image/" class="leancloud_visitors" data-flag-title="responsive images">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images" target="_blank" rel="noopener">Responsive Images</a>学习笔记</p>
<h2 id="why-need-responsive-images"><a href="#why-need-responsive-images" class="headerlink" title="why need responsive images"></a>why need responsive images</h2><p>假设我们在做一个网页，页面上需要一些图片，在PC端打开这个网页，图片是很清晰很合适的。此时被告知，这个页面在移动端也需要用到，把页面调成手机模式，可以发现屏幕变窄了，图片变得很小而且不清晰。可以看下mdn的一个例子：<a href="https://mdn.github.io/learning-area/html/multimedia-and-embedding/responsive-images/not-responsive.html" target="_blank" rel="noopener">no responsive example</a>,<a href="https://mdn.github.io/learning-area/html/multimedia-and-embedding/responsive-images/responsive.html" target="_blank" rel="noopener">responsive example</a></p>
<p>art direction problem: 当在一个狭窄的屏幕，或者中等屏幕比如平板上浏览网页时，显示一个裁剪后的图片会更好。比如，我们在PC上有一张人物在中间，背景较大，人物较小的图片，当放到移动端查看时，图片被缩小，人物就几乎看不清楚了，最好是在手机端显示一个人物放大的裁剪后的图片。<br>resolution switch problem: 如果在一个较小的移动屏幕上观看，就不需要使用那么大的图片，这就是所谓的分辨率切换问题。对比于矢量图片，栅格图片如果显示的尺寸大于本身的尺寸时，视觉效果是很糟糕的；当显示尺寸小于本身的尺寸时，对带宽又是一种浪费，尤其对于手机用户，一个小尺寸的图片就能显示很好的效果，却要浪费带宽去下载一个为PC设计的大图片。所以较理想的方案是根据不同的设备尺寸显示不同大小的图片。你可能会说矢量图片可以解决上面的问题，矢量图片一般都较小，并且对于简单的图形、模式、界面元素等等都表现的很好，但是对于一些复杂的图像，创建矢量图会变得很复杂。</p>
<p>上面的这些问题在web开发前期是不存在的，因为那时候上网的主要设备是台式机和笔记本，所以浏览器引擎和早期的规范都没考虑这个问题。响应式图片技术是最近才实现的技术，给浏览器提供多个图片文件，展示同样的内容但是不同的像素大小(resolution switching)，也可以是在不同的空间使用不同的图片(art direction)。</p>
<h2 id="Create-Responsive-Images"><a href="#Create-Responsive-Images" class="headerlink" title="Create Responsive Images"></a>Create Responsive Images</h2><h3 id="Resolution-Switching"><a href="#Resolution-Switching" class="headerlink" title="Resolution Switching"></a>Resolution Switching</h3><p>我们将要使用<code>&lt;img&gt;</code>元素来创建响应式图片，根据设备大小显示合适大小的图片。一般在使用img时，主要指定src和alt属性：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"logo.jpg"</span> <span class="attr">alt</span>=<span class="string">"logo"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面要介绍两个新的属性：<code>srcset</code>、 <code>sizes</code>,提供一些带提示的图片源，帮助浏览器选择更合适的图片展示。</p>
<h4 id="srcset"><a href="#srcset" class="headerlink" title="srcset"></a>srcset</h4><p><code>srcset</code>提供一系列可供选择的图片字符串，字符串的组合为：</p>
<ul>
<li>图片路径</li>
<li>可选描述符如下，每个描述符前有空格<ul>
<li>宽度描述符：一个后跟w的正数。宽度描述符除以<code>sizes</code>属性中给定的size，用以计算像素密度。</li>
<li>像素密度描述符：一个后跟x的正浮点数。</li>
</ul>
</li>
</ul>
<p>如果没有指定任何描述符，会分配默认的描述符<code>1x</code>。</p>
<p>不要在srcset属性中混合宽度描述符和像素密度描述符，或者指定重复的描述符，比如两张图片都使用2x作为描述符。<br>这为浏览器提供了很大的选择余地，浏览器可以根据用户偏好或者带宽条件，从提供的图片源中选择最合适的一张图片显示。</p>
<h4 id="sizes"><a href="#sizes" class="headerlink" title="sizes"></a>sizes</h4><p><code>sizes</code>提供一系列图片size的字符串，字符串组合为：</p>
<ul>
<li>媒体查询条件，最后一个字符串省略这项，作为默认size</li>
<li>a source size value, 用以指定图片的预期显示大小。</li>
</ul>
<p>当<code>srcset</code>中提供了宽度描述符，用户浏览器会根据当前的source size来选择<code>srcset</code>中提供的图片。被选择的source size会影响图片的原始大小（如果没有使用CSS样式）。如果没有提供srcset属性，或者srcset属性中没有宽度描述符或包含无效宽度描述符，<code>sizes</code>属性就不起作用。</p>
<h4 id="width-descriptor"><a href="#width-descriptor" class="headerlink" title="width descriptor"></a>width descriptor</h4><p>eg: <a href="https://mdn.github.io/learning-area/html/multimedia-and-embedding/responsive-images/responsive.html" target="_blank" rel="noopener">responsive-width</a><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">srcset</span>=<span class="string">"320w.jpg 320w,</span></span></span><br><span class="line"><span class="tag"><span class="string">             480w.jpg 480w,</span></span></span><br><span class="line"><span class="tag"><span class="string">             800w.jpg 800w"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">sizes</span>=<span class="string">"(max-width: 320px) 280px,</span></span></span><br><span class="line"><span class="tag"><span class="string">            (max-width: 480px) 440px,</span></span></span><br><span class="line"><span class="tag"><span class="string">            800px"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">src</span>=<span class="string">"800w.jpg"</span> <span class="attr">alt</span>=<span class="string">"Elva dressed as a fairy"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>上面代码的意思是：<br>srcset:向浏览器提供了三张图片，宽度分别为320px, 480px，800px。<br>sizes:当设备大小小于320px时，图片预计显示大小为280px；当设备大小小于480px时，图片预计显示大小为440px；其他设备大小，图片预计显示大小为800px。</p>
<p>浏览器的选择过程：</p>
<ol>
<li>查询当前设备宽度</li>
<li>根据sizes中的媒体查询条件，找到第一个为true的条件下图片预计显示大小</li>
<li>加载srcset中图片宽度最靠近步骤2中获取的预计图片显示大小的图片</li>
</ol>
<p>所以如果一个设备宽度为480px的浏览器加载这个网页，(max-width: 480px)的媒体查询条件满足，图片预计展示大小为440px，srcset属性中最靠近440px的图片为480w.jpg，因此浏览器会加载480w.jpg。假设800px的图片大小为128kb，480px的图片大小为63kb，就可以节约65kb。所以当一个网页上有很多图片时，使用响应式图片就可以为手机用户节约很多带宽。<br>对于不支持srcset和sizes属性的旧浏览器，浏览器就会忽略这两个属性，加载src中定义的图片。</p>
<p><strong>note:</strong>一些手机浏览器会使用错误的视口宽度，它们会加载一个适合更大视口上加载的网页，然后展示缩小的页面，这样的话很不适合响应式图片的设计。因此我们可以在<code>head</code>中使用<code>&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;</code>来强制手机浏览器使用真实的视口宽度来加载网页。</p>
<h4 id="pixel-density-descriptor"><a href="#pixel-density-descriptor" class="headerlink" title="pixel density descriptor"></a>pixel density descriptor</h4><p>如果需要支持多种显示分辨率，但每个人在屏幕上看到的大小都跟真实的大小一样，可以允许浏览器选择合适的分辨率图像。这时可以使用像素密度描述符描述<code>srcset</code>中的图片源，并省略<code>sizes</code>属性。可以看这个例子：<a href="https://mdn.github.io/learning-area/html/multimedia-and-embedding/responsive-images/srcset-resolutions.html" target="_blank" rel="noopener">responsive-resolutions</a><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">srcset</span>=<span class="string">"320w.jpg,</span></span></span><br><span class="line"><span class="tag"><span class="string">             480w.jpg 1.5x,</span></span></span><br><span class="line"><span class="tag"><span class="string">             640w.jpg 2x"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">src</span>=<span class="string">"640w.jpg"</span> <span class="attr">alt</span>=<span class="string">"Elva dressed as a fairy"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在这个例子中，我们不需要<code>sizes</code>，因为浏览器只会根据分辨率来选择图片，如果浏览器分辨率为1，加载320w.jpg；浏览器分辨率为1.5时，加载480w.jpg；浏览器分辨率为2时，加载640w.jpg。</p>
<h3 id="Art-direction"><a href="#Art-direction" class="headerlink" title="Art direction"></a>Art direction</h3><p>总的来说，art direction problem 涉及到要改变图片来适应不同的图片展示大小。还是一开始那个例子，人物照背景很大，放到手机端，人物就会很小，可以放一张裁剪的，人物被放大的图片在手机端展示。可以使用<code>&lt;picture&gt;</code>来实现。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">picture</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">media</span>=<span class="string">"(max-width: 799px)"</span> <span class="attr">srcset</span>=<span class="string">"480w.jpg"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">media</span>=<span class="string">"(min-width: 800px)"</span> <span class="attr">srcset</span>=<span class="string">"800w.jpg"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1240w.jpg"</span> <span class="attr">alt</span>=<span class="string">"Chris standing up holding his daughter Elva"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picture</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>&lt;source&gt;</code>的media属性，起到媒体查询的作用，上面的例子表示：当设备宽度小于799px时，加载480w.jpg，如果设备宽度大于800px，加载800w.jpg。</li>
<li>srcset属性包含图片路径，跟之前的<code>&lt;img&gt;</code>一样，<code>&lt;source&gt;</code>也有srcset属性，可以接受一组图片路径，也有sizes属性。因此<code>&lt;picture&gt;</code>可以提供不同的图片，同时还可以提供不同分辨率下显示的图片。但是不要同时使用sizes和media属性。</li>
<li>在<code>&lt;/picture&gt;</code>前必须有<code>&lt;img&gt;</code>元素，带有src和alt属性，不然就不会有图片显示。当所有查询条件都不满足时，会展示img中的元素。</li>
</ul>
<p>我们还可以给<code>&lt;picture&gt;</code>提供type属性，存储MIME类型，对于不支持的文件类型，浏览器可以立即放弃：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">picture</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">type</span>=<span class="string">"image/svg+xml"</span> <span class="attr">srcset</span>=<span class="string">"pyramid.svg"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">type</span>=<span class="string">"image/webp"</span> <span class="attr">srcset</span>=<span class="string">"pyramid.webp"</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"pyramid.png"</span> <span class="attr">alt</span>=<span class="string">"regular pyramid built from four equilateral triangles"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picture</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>除非需要art direction，否则不要使用media属性</li>
<li>在<code>&lt;source&gt;</code>中，srcset只能引入type类型定义的图像类型</li>
<li>需要的时候，也可以使用srcset和sizes定义一系列图片源</li>
</ul>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/source" target="_blank" rel="noopener">source属性</a></p>
<h2 id="webpack-tools"><a href="#webpack-tools" class="headerlink" title="webpack tools"></a>webpack tools</h2><p><code>responsive-loader</code>和<code>resize-image-loader</code>可以生成不同尺寸的图片作为srcset，对于根据设备宽度选择图片时，我们只需要一张图片，webpack就可以在引入时帮我们生成多个size的图片，作为srcset图片源。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images" target="_blank" rel="noopener">Responsive Images</a></li>
<li><a href="http://www.zhangxinxu.com/wordpress/2015/11/anatomy-of-responsive-images/" target="_blank" rel="noopener">图解img picture使用场景</a></li>
<li><a href="http://www.zhangxinxu.com/wordpress/2014/10/responsive-images-srcset-size-w-descriptor/" target="_blank" rel="noopener">响应式图片</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img" target="_blank" rel="noopener"><code>&lt;img&gt;</code></a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/source" target="_blank" rel="noopener"><code>&lt;source&gt;</code></a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/picture" target="_blank" rel="noopener"><code>&lt;picture&gt;</code></a></li>
<li><a href="https://www.npmjs.com/package/responsive-loader" target="_blank" rel="noopener">responsive-loader</a></li>
<li><a href="https://www.npmjs.com/package/resize-image-loader" target="_blank" rel="noopener">resize-image-loader</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/11/surviveJS-webpack-loadingAssets/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/11/surviveJS-webpack-loadingAssets/" itemprop="url">surviveJS-webpack-loadingAssets学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-11T16:15:57+08:00">2018-04-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/11/surviveJS-webpack-loadingAssets/" class="leancloud_visitors" data-flag-title="surviveJS-webpack-loadingAssets学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><a href="https://survivejs.com/webpack/loading/" target="_blank" rel="noopener">surviveJS-webpack-loadingAssets</a></strong></p>
<h2 id="Loader-definitions"><a href="#Loader-definitions" class="headerlink" title="Loader definitions"></a>Loader definitions</h2><h3 id="Enforcing-Order"><a href="#Enforcing-Order" class="headerlink" title="Enforcing Order"></a>Enforcing Order</h3><p>loader的使用顺序是从右到左，从下到上，但是我们仍然可以通过enforce字段定义该loader的执行是优先于普通loader还是落后于普通loader。可选的值为<code>pre</code>和<code>post</code>。<br>举个例子：eslint-loader要优先于其他loader的执行<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Conditions</span></span><br><span class="line">  test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">  enforce: <span class="string">"pre"</span>, <span class="comment">// "post" too</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Actions</span></span><br><span class="line">  use: <span class="string">"eslint-loader"</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>如果我们把需要的loader链接起来，也可以不使用enforce使得该loader优先于其他loader的执行。使用enforce就可以将loader分成几个阶段，也更容易组合。</p>
<h3 id="Parsing-parameters-to-a-Loader"><a href="#Parsing-parameters-to-a-Loader" class="headerlink" title="Parsing parameters to a Loader"></a>Parsing parameters to a Loader</h3><p>推荐使用下面这种方式<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">  include: PATHS.app,</span><br><span class="line"></span><br><span class="line">  use: [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        presets: [<span class="string">"env"</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// Add more loaders here</span></span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="Alternate-ways-to-Match-files"><a href="#Alternate-ways-to-Match-files" class="headerlink" title="Alternate ways to Match files"></a>Alternate ways to Match files</h3><ul>
<li>resource: 匹配资源路径，匹配时包括query. eg: <code>resource: /inline/</code>, <code>/path/foo.inline.js</code>, <code>/path/bar.png?inline</code></li>
<li>issure: Match against a resource requested from the match. Example:<code>issure: /bar.js/</code>, then <code>/path/foo.png</code> would match if it was requested from <code>/path/bar.js</code>. </li>
<li>resourcePath: 匹配资源路径，不包括query. eg: <code></code>resourcePath: /inline/<code>,</code>/path/foo.inline.png`</li>
<li>resourceQuery: 匹配query. eg: <code>resourceQuery: /inline/</code>, <code>/path/foo.png?inline</code></li>
</ul>
<p>还可以结合一些布尔值使用：</p>
<ul>
<li>not: 条件不匹配时匹配</li>
<li>and: 数组，仅当所有条件都匹配时匹配</li>
<li>or: 数组，任意条件匹配时匹配</li>
</ul>
<h3 id="Loading-Based-on-ResourceQuery"><a href="#Loading-Based-on-ResourceQuery" class="headerlink" title="Loading Based on ResourceQuery"></a>Loading Based on ResourceQuery</h3><p>oneOf只使用嵌套规则之一<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.png$/</span>,</span><br><span class="line">  oneOf: [</span><br><span class="line">    &#123;</span><br><span class="line">      resourceQuery: <span class="regexp">/inline/</span>,</span><br><span class="line">      use: <span class="string">"url-loader"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      resourceQuery: <span class="regexp">/external/</span>,</span><br><span class="line">      use: <span class="string">"file-loader"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="Loading-Based-on-Issuer"><a href="#Loading-Based-on-Issuer" class="headerlink" title="Loading Based on Issuer"></a>Loading Based on Issuer</h3><p>issuer可以用来控制资源是从哪里引入的。下面这个例子匹配当JS文件引入了一个CSS文件时。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.css$/</span>,</span><br><span class="line"></span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      issuer: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      use: <span class="string">"style-loader"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      use: <span class="string">"css-loader"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>和<code>not</code>结合：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.css$/</span>,</span><br><span class="line"></span><br><span class="line">  rules: [</span><br><span class="line">    <span class="comment">// CSS imported from other modules is added to the DOM</span></span><br><span class="line">    &#123;</span><br><span class="line">      issuer: &#123; <span class="attr">not</span>: <span class="regexp">/\.css$/</span> &#125;,</span><br><span class="line">      use: <span class="string">"style-loader"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// Apply css-loader against CSS imports to return CSS</span></span><br><span class="line">    &#123;</span><br><span class="line">      use: <span class="string">"css-loader"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Understanding-Loader-Behavior"><a href="#Understanding-Loader-Behavior" class="headerlink" title="Understanding Loader Behavior"></a>Understanding Loader Behavior</h3><p>可以通过监控loader来了解他们的行为。<code>loader-runner</code>可以在隔离webpack环境下运行Loader. <code>inspect-loader</code>可以查看loaders之间传递的内容，不需要在node_modules中插入console.logs，只需要把这个Loader放在你的配置中就可以监控这里的流程。</p>
<h2 id="Loading-Images"><a href="#Loading-Images" class="headerlink" title="Loading Images"></a>Loading Images</h2><p><code>url-loader</code>可以将你的图片输出为base64的字符串，打包到你的JS bundle中。这种处理以增大JS bundle大小为代价，减少了请求数量。在开发环境使用是可以的，但是生产环境中需要更加优化的方式。<br><code>file-loader</code>会将Image输出为文件，并返回路径。<code>file-loader</code>也适用于其他类型的assets，比如fonts。</p>
<h3 id="Setting-up-url-loader"><a href="#Setting-up-url-loader" class="headerlink" title="Setting up url-loader"></a>Setting up url-loader</h3><p><code>url-loader</code>有一个<code>limit</code>选项，可以在达到绝对限制后，使用<code>file-loader</code>延迟图像输出。如果使用<code>limit</code>选项，那你的项目中需要同时安装有<code>url-loader</code>和<code>file-loader</code>。配置成功后，webpack会解析样式文件中所有的<code>url()</code>表达式。如果在超过limit限制后，不希望用<code>file-loader</code>处理，可以设置<code>fallback:&#39;some-loader&#39;</code>，超过限制后便可以使用设置的Loader来处理图片。<br>下面的例子是配置25KB以下的图片使用<code>url-loader</code>处理，超过25KB的使用<code>file-loader</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.(jpg|png)$/</span>,</span><br><span class="line">  use: &#123;</span><br><span class="line">    loader: <span class="string">"url-loader"</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">      limit: <span class="number">25000</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="Setting-up-file-loader"><a href="#Setting-up-file-loader" class="headerlink" title="Setting up file-loader"></a>Setting up file-loader</h3><p>如果希望所有图片都不使用内联方式，可以直接使用<code>file-loader</code>，默认情况下<code>file-loader</code>会返回MD5哈希和原来的扩展名.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.(jpg|png)$/</span>,</span><br><span class="line">  use: &#123;</span><br><span class="line">    loader: <span class="string">"file-loader"</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">      name: <span class="string">"./images/[path][name].[hash].[ext]"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="Integrating-Images-to-the-Project"><a href="#Integrating-Images-to-the-Project" class="headerlink" title="Integrating Images to the Project"></a>Integrating Images to the Project</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add file-loader url-loader -D</span><br></pre></td></tr></table></figure>
<p>webpack.parts.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">exports.loadImages = <span class="function">(<span class="params">&#123; include, exclude, options &#125; = &#123;&#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(png|jpg)$/</span>,</span><br><span class="line">        include,</span><br><span class="line">        exclude,</span><br><span class="line">        use: &#123;</span><br><span class="line">          loader: <span class="string">"url-loader"</span>,</span><br><span class="line">          options,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>使用<code>limit</code>时，<code>url-loader</code>会将额外的配置传给<code>file-loader</code>.<br>webpack.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parts.loadImages(&#123;</span><br><span class="line">    options: &#123;</span><br><span class="line">      limit: <span class="number">15000</span>,</span><br><span class="line">      name: <span class="string">"[name].[ext]"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> developmentConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parts.loadImages(),</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>上面的例子是在开发环境中使用<code>url-loader</code>,在生产环境中使用<code>url-loader</code>和<code>file-loader</code>.<br>开发环境：<br><img src="/2018/04/11/surviveJS-webpack-loadingAssets/url-console.png" alt=""><br><img src="/2018/04/11/surviveJS-webpack-loadingAssets/url-loader.png" alt=""><br>生产环境：<br><img src="/2018/04/11/surviveJS-webpack-loadingAssets/file-console.png" alt=""><br><img src="/2018/04/11/surviveJS-webpack-loadingAssets/file-loader.png" alt=""></p>
<p>在生产环境中还可以将图片压缩，可以使用<code>image-webpack-loader</code>,<code>svgo-loader</code>(SVG specific), <code>imagemin-webpack-plugin</code>。这类loader都应该先处理数据，因此需要将其放在<code>use</code>列表的最下面。</p>
<h3 id="utilizing-srcset"><a href="#utilizing-srcset" class="headerlink" title="utilizing srcset"></a>utilizing srcset</h3><p><code>responsive-loader</code>和<code>resize-image-loader</code>可以生成srcset，srcset可以使浏览器更好的控制加载什么样的图片，性能也更好。</p>
<blockquote>
<p>A webpack loader for responsive images. Creates multiple images from one source image, and returns a srcset. For more information on how to use srcset, read <strong><a href="https://css-tricks.com/responsive-images-youre-just-changing-resolutions-use-srcset/" target="_blank" rel="noopener">Responsive Images</a></strong>: If you’re just changing resolutions, use srcset.. Browser support is <a href="https://caniuse.com/#search=srcset" target="_blank" rel="noopener">pretty good</a></p>
</blockquote>
<h3 id="Loading-sprites"><a href="#Loading-sprites" class="headerlink" title="Loading sprites"></a>Loading sprites</h3><p><code>webpack-spritesmith</code> converts provided images into a sprite sheet and Sass/Less/Stylus mixins.<br>需要设置<code>spritesmithPlugin</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">import</span> <span class="string">"~sprite.sass"</span>;</span><br><span class="line"></span><br><span class="line">.close-button &#123;</span><br><span class="line">  sprite($close);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.open-button &#123;</span><br><span class="line">  sprite($open);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Using-placeholders"><a href="#Using-placeholders" class="headerlink" title="Using placeholders"></a>Using placeholders</h3><p><code>image-trace-loader</code>加载图片，输出类似<code>image/svg+xml</code> URL encoded数据。可以结合<code>file-loader</code>和<code>url-loader</code>使用，当真实图片还未完全加载时展示placeholder.<br><code>lqip-loader</code>会使用模糊的图片做Placeholder.<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">exports.loadImage = <span class="function">(<span class="params">&#123; include, exclude, options &#125; = &#123;&#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(jpg|png)$/</span>,</span><br><span class="line">        include,</span><br><span class="line">        exclude,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'image-trace-loader'</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'url-loader'</span>,</span><br><span class="line">            options,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在webpack.config.js中这样设置会对所有的图片都起作用，也可以不在webpack.config.js中配置，在引入图片时加入loader，如下面的示例：</p>
<p>component.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (text = <span class="string">'Hello world'</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> image = <span class="built_in">require</span>(<span class="string">'!!image-trace-loader?color=#BBCBD1&amp;background=#FFF!./logo.png'</span>);</span><br><span class="line">  <span class="keyword">const</span> img1 = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  <span class="keyword">const</span> img2 = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  <span class="keyword">const</span> div = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">  img1.src = image.trace;</span><br><span class="line">  img1.className = <span class="string">'trace'</span>;</span><br><span class="line">  div.appendChild(img1);</span><br><span class="line"></span><br><span class="line">  img2.src = image.src;</span><br><span class="line">  img2.className = <span class="string">'image'</span>;</span><br><span class="line">  div.appendChild(img2);</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    img2.className = <span class="string">'image loaded'</span>;</span><br><span class="line">  &#125;, <span class="number">500</span> + <span class="built_in">Math</span>.random() * <span class="number">1500</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> div;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>main.css<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">transition</span>: opacity <span class="number">1000ms</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.image</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.loaded</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/04/11/surviveJS-webpack-loadingAssets/gray.png" alt=""><br>图片会先由黑白的渐变为正常的图片。</p>
<h3 id="Getting-Image-Dimentions"><a href="#Getting-Image-Dimentions" class="headerlink" title="Getting Image Dimentions"></a>Getting Image Dimentions</h3><p><code>image-size-loader</code>可以获取Image的尺寸，类型等信息。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = <span class="built_in">require</span>(<span class="string">"./image.png"</span>);</span><br><span class="line"><span class="comment">// =&gt; &#123;width: 500, height: 700, type: "png", src: __webpack_public_path__ + "image.png", bytes: 1234&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Referencing-to-Images"><a href="#Referencing-to-Images" class="headerlink" title="Referencing to Images"></a>Referencing to Images</h3><p>如果配置了<code>css-loader</code>,webpack可以通过<code>@import</code>,<code>url()</code>,从样式表中找到图片。同时我们也可以在代码中使用，这时需要显式的引入这张图片。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> src <span class="keyword">from</span> <span class="string">"./avatar.png"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use the image in your code somehow now</span></span><br><span class="line"><span class="keyword">const</span> Profile = <span class="function"><span class="params">()</span> =&gt;</span> &lt;img src=&#123;src&#125; /&gt;;</span><br></pre></td></tr></table></figure></p>
<p>如果使用的是react，可以使用<code>babel-plugin-transform-react-jsx-img-import</code>自动生成require,代码就可以这样写：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Profile = <span class="function"><span class="params">()</span> =&gt;</span> &lt;img src=<span class="string">"avatar.png"</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="Images-and-css-loader-source-map-gotcha"><a href="#Images-and-css-loader-source-map-gotcha" class="headerlink" title="Images and css-loader source map gotcha"></a>Images and css-loader source map gotcha</h3><p>如果使用了images，并且允许css-loader的sourceMap，需要设置<code>output.publicPath</code>为指向development server的绝对值。like:<code>publicPath: &#39;http://0.0.0.0:8080/&#39;</code></p>
<h2 id="Loading-javascript"><a href="#Loading-javascript" class="headerlink" title="Loading javascript"></a>Loading javascript</h2><p>一些ES2015的语法在旧浏览器中会不支持，因此可以使用<code>Babel</code>–一个javascript编译器，支持Es2015的语法。可以通过<code>babel-loader</code>使用Babel，</p>
<blockquote>
<p>Connecting Babel with a project allows you to process webpack configuration through it. To achieve this, name your webpack configuration using the webpack.config.babel.js convention. interpret package enables this, and it supports other compilers as well.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add babel-loader babel-core -D</span><br></pre></td></tr></table></figure>
<p>webpack.prats.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">exports.loadJavaScript = <span class="function">(<span class="params">&#123; include, exclude &#125; = &#123;&#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        include,</span><br><span class="line">        exclude,</span><br><span class="line">        use: <span class="string">"babel-loader"</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commonConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parts.loadJavaScript(&#123; <span class="attr">include</span>: PATHS.app &#125;),</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<h3 id="Setting-up-babelrc"><a href="#Setting-up-babelrc" class="headerlink" title="Setting up .babelrc"></a>Setting up .babelrc</h3><blockquote>
<p>At a minimum, you need <code>babel-preset-env</code>. It’s a Babel preset that enables the required plugins based on the optional environment definition you pass to it.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add babel-preset-env -D</span><br></pre></td></tr></table></figure>
<p>webpack默认支持ES2015的modules，因此可以告知babel跳过处理modules。但是跳过处理modules可能会破坏webpack的HMR机制，然而生产环境并不会受到影响。<br>.babelrc<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">"env"</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"modules"</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="polyfilling-features"><a href="#polyfilling-features" class="headerlink" title="polyfilling features"></a>polyfilling features</h3><p><code>babel-preset-env</code>可以为一些旧浏览器polyfill一些语言特性，但是需设置<code>useBuiltIns: true</code>并安装<code>babel-polyfill</code>，需要将其引入你的项目或者入口（<code>app:[&quot;babel-polyfill&quot;, PATHS.app]</code>）。<code>babel-preset-env</code>根据你的浏览器定义重写import，并加载需要的polyfills。<br><code>babel-polyfill</code>会用类似Promise对象这种污染全局环境，可以用<a href="https://babeljs.io/docs/plugins/transform-runtime/" target="_blank" rel="noopener"><code>transform-runtime</code></a>来解决。</p>
<h3 id="Enabling-Presets-and-Plugins-per-Environment"><a href="#Enabling-Presets-and-Plugins-per-Environment" class="headerlink" title="Enabling Presets and Plugins per Environment"></a>Enabling Presets and Plugins per Environment</h3><p><code>Babel</code>可以通过env选项控制哪些环境下使用哪些presets和plugins。<code>env</code>会检查<code>NODE_ENV</code>和<code>BABEL_ENV</code>,并根据他们在编译中使用不同的presets和plugins. 如果设置了<code>BABEL_ENV</code>,会覆盖<code>NODE_ENV</code>.<br>.babelrc<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">"env"</span>: &#123;</span><br><span class="line">    <span class="string">"development"</span>: &#123;</span><br><span class="line">      <span class="string">"plugins"</span>: [</span><br><span class="line">        <span class="string">"annotate-console-log"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以用webpack环境来调整Babel环境：<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">mode</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  process.env.BABEL_ENV = mode;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Babel允许你控制项目需要支持的浏览器，它可以编译ES2015+特性使得老的浏览器能够支持。<code>babel-preset-env</code>可以根据你要支持的浏览器定义来选择要编译的特性和应用哪些polyfills。</li>
<li>使用Babel可以体验一些实验性语言特性，可以找到很多plugins来提高开发体验和项目性能。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/10/emacs-keys/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/10/emacs-keys/" itemprop="url">emacs keys</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-10T10:28:37+08:00">2018-04-10</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/工具/" itemprop="url" rel="index"><span itemprop="name">工具</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/10/emacs-keys/" class="leancloud_visitors" data-flag-title="emacs keys">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>记录一些常用的spacemacs快捷键<br>C 代表 Ctrl<br>M 代表 Option</p>
<h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// 退出</span><br><span class="line">退出emacs: C x C c</span><br><span class="line">退出当前操作：C g</span><br><span class="line"></span><br><span class="line">// 光标移动</span><br><span class="line">上一行：C p</span><br><span class="line">下一行：C n</span><br><span class="line">右移：C f</span><br><span class="line">右移一个单词：M f</span><br><span class="line">左移：C b</span><br><span class="line">左移一个单词：M b</span><br><span class="line">行首：C a</span><br><span class="line">行尾：C e</span><br><span class="line">删除光标后的单词：M d</span><br><span class="line">删除光标前的单词：M delete</span><br><span class="line">删除一个字母：C d</span><br><span class="line">删除某一行光标后的所有内容：C k</span><br><span class="line">光标所在区域定位到页面中间：C l</span><br><span class="line">光标移动到页面顶部：M shift &lt;</span><br><span class="line">光标移动到页面底部：M shift &gt;</span><br><span class="line">选中光标所在的单词：M m M w  扩大选中区域：w  缩小选中区域：V</span><br><span class="line">选中光标所在chunk: M h</span><br><span class="line"></span><br><span class="line">emacs黏贴：C y</span><br><span class="line">emacs剪切：C w</span><br><span class="line">emacs复制：M w</span><br><span class="line">全局复制：M m o y</span><br><span class="line"></span><br><span class="line">撤销操作：C -</span><br><span class="line">反撤销：C x u      q(quit)</span><br><span class="line"> </span><br><span class="line">选择模式：C space</span><br><span class="line">操作：M m M l  往右缩进：space   往左缩进：delete</span><br><span class="line"></span><br><span class="line">打开，新建文件：C x C f</span><br><span class="line">保存文件：C x C s</span><br></pre></td></tr></table></figure>
<h2 id="dired-mode"><a href="#dired-mode" class="headerlink" title="dired mode"></a>dired mode</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">打开dired mode: C x C j</span><br><span class="line">删除光标所在文件：D</span><br><span class="line">复制光标所在文件：C</span><br><span class="line">重命名或移动光标所在文件：R</span><br><span class="line">上一层目录：shift ^</span><br><span class="line">标记当前文件：m 若要标记多个文件: C space选择文件  m 标记</span><br><span class="line">取消标记光标所在文件：u 若要取消多个文件标记：C space选择文件 u 取消</span><br><span class="line"></span><br><span class="line">切换工程：C c p p</span><br><span class="line">切换到前一个buffer: M m tab</span><br><span class="line">查看所有打开的文件：M m f r</span><br></pre></td></tr></table></figure>
<h2 id="查找操作"><a href="#查找操作" class="headerlink" title="查找操作"></a>查找操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查找当前项目下的单词：C space 选择单词  / 开始搜索</span><br><span class="line">查找当前项目下的文件：C c p f</span><br><span class="line">查找当前文件下光标所在的单词：C c d(自定义的)</span><br><span class="line">查找当前文件下的单词：C s input word</span><br><span class="line">查找当前项目下某个路径范围内的单词：C c s 输入-G路径 单词 即可搜索路径内的单词</span><br></pre></td></tr></table></figure>
<h2 id="窗口操作"><a href="#窗口操作" class="headerlink" title="窗口操作"></a>窗口操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">右侧打开窗口：M m w v</span><br><span class="line">循环切换窗口：C x o </span><br><span class="line">多个窗口中保留当前光标所在窗口，关闭其他窗口：C x 1</span><br><span class="line">退出当前光标所在窗口：C x 0</span><br><span class="line">neotree上右侧打开窗口：shift |</span><br></pre></td></tr></table></figure>
<h2 id="magit"><a href="#magit" class="headerlink" title="magit"></a>magit</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">打开操作界面：M m g s</span><br><span class="line">折叠当前光标下的文件：tab 查看上一个chunk：p 查看下一个chunk: n 进入这个文件：enter</span><br><span class="line">缓存当前光标下的文件：s</span><br><span class="line">提交：cc</span><br><span class="line">提交页面放弃提交操作：C c C k</span><br><span class="line">撤销缓存当前光标下的文件：u</span><br><span class="line">放弃当前文件操作：k</span><br><span class="line">刷新：g</span><br><span class="line">帮助：shift ?</span><br><span class="line">git blame：M m g b  q(quit)</span><br><span class="line">查看当前文件的History：M m g t</span><br><span class="line">剪切commit号：M w</span><br></pre></td></tr></table></figure>
<h2 id="eslint"><a href="#eslint" class="headerlink" title="eslint"></a>eslint</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看eslint error: C c ! p/n/l</span><br><span class="line">查看底部出现的所有提示：M m w p m</span><br></pre></td></tr></table></figure>
<h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查询函数：C h f</span><br><span class="line">执行命令：M x</span><br><span class="line">上一页：C v</span><br><span class="line">下一页：M v</span><br><span class="line">教程：C h t</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/09/surviveJS-webpack-styling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/09/surviveJS-webpack-styling/" itemprop="url">surviveJS-webpack-styling学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-09T14:41:10+08:00">2018-04-09</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/09/surviveJS-webpack-styling/" class="leancloud_visitors" data-flag-title="surviveJS-webpack-styling学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><a href="https://survivejs.com/webpack/styling/" target="_blank" rel="noopener">surviveJS-webpack-styling</a></strong></p>
<h2 id="Loading-Styles"><a href="#Loading-Styles" class="headerlink" title="Loading Styles"></a>Loading Styles</h2><p>webpack默认是不支持加载CSS的，所以我们需要使用loaders和plugins来加载样式文件。<br>加载CSS，需要用到css-loader和style-loader。</p>
<blockquote>
<p> css-loader goes through possible @import and url() lookups within the matched files and treats them as a regular ES2015 import.If an @import points to an external resource, css-loader skips it as only internal resources get processed further by webpack.<br> style-loader injects the styling through a style element. The way it does this can be customized. It also implements the Hot Module Replacement interface providing pleasant development experience.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add style-loader css-loader -D</span><br></pre></td></tr></table></figure>
<p>webpack.parts.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">exports.loadCSS = <span class="function">(<span class="params">&#123; include, exclude &#125; = &#123;&#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        include,</span><br><span class="line">        exclude,</span><br><span class="line"></span><br><span class="line">        use: [<span class="string">"style-loader"</span>, <span class="string">"css-loader"</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>loaders的执行顺序是从右到左，从下到上，也就是说这里的loader执行是先执行css-loader，然后再到style-loader，可以这样理解<code>style-loader(css-loader(input))</code><br>webpack.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commonConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parts.loadCSS(),</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>src/main.css<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: cornsilk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>src/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"./main.css"</span>;</span><br></pre></td></tr></table></figure></p>
<p>这样样式就可以生效啦。</p>
<h3 id="Loading-Less"><a href="#Loading-Less" class="headerlink" title="Loading Less"></a>Loading Less</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">  use: [<span class="string">"style-loader"</span>, <span class="string">"css-loader"</span>, <span class="string">"less-loader"</span>],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h3 id="Loading-Sass"><a href="#Loading-Sass" class="headerlink" title="Loading Sass"></a>Loading Sass</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">  use: [<span class="string">"style-loader"</span>, <span class="string">"css-loader"</span>, <span class="string">"sass-loader"</span>],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><code>sass-loader</code>依赖于<code>node-sass</code>,所以项目还需要安装<code>node-sass</code>.</p>
<h3 id="Loading-Stylus-and-Yeticss"><a href="#Loading-Stylus-and-Yeticss" class="headerlink" title="Loading Stylus and Yeticss"></a>Loading Stylus and Yeticss</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.styl$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">"style-loader"</span>,</span><br><span class="line">          <span class="string">"css-loader"</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">"stylus-loader"</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              use: [<span class="built_in">require</span>(<span class="string">"yeticss"</span>)],</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>还需要在项目中引入<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">import</span> <span class="string">"yeticss"</span></span><br><span class="line"><span class="comment">//or</span></span><br><span class="line">@<span class="keyword">import</span> <span class="string">"yeticss/components/type"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="PostCSS"><a href="#PostCSS" class="headerlink" title="PostCSS"></a>PostCSS</h3><p><a href="http://postcss.org/" target="_blank" rel="noopener">PostCSS</a>的插件系统可以将CSS转化为JS，相当于样式中的Babel。</p>
<blockquote>
<p>PostCSS allows you to inject functionality to CSS in through its plugin system. cssnext is an example of a collection of plugins for PostCSS that implements future features of CSS.</p>
</blockquote>
<p>下面这个例子是自动添加前缀.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">  use: [</span><br><span class="line">    <span class="string">"style-loader"</span>,</span><br><span class="line">    <span class="string">"css-loader"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">"postcss-loader"</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        plugins: <span class="function"><span class="params">()</span> =&gt;</span> ([</span><br><span class="line">          <span class="built_in">require</span>(<span class="string">"autoprefixer"</span>)(),</span><br><span class="line">        ]),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="cssnext"><a href="#cssnext" class="headerlink" title="cssnext"></a>cssnext</h3><p><a href="http://cssnext.io/" target="_blank" rel="noopener">cssnext</a>是postcss-loader的一个插件，可以体验一些未来的特性。可以通过postcss-cssnext来使用。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  use: &#123;</span><br><span class="line">    loader: <span class="string">"postcss-loader"</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">      plugins: <span class="function"><span class="params">()</span> =&gt;</span> [<span class="built_in">require</span>(<span class="string">"postcss-cssnext"</span>)()],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>cssnext就包括了autoprefixer，所以使用cssnext就可以不用autoprefixer了。</p>
<h3 id="Understanding-Lookups"><a href="#Understanding-Lookups" class="headerlink" title="Understanding Lookups"></a>Understanding Lookups</h3><p>css-loader默认会处理相对路径的引入，但不会处理绝对路径的引入，类似<code>url(&quot;/static/img/demo.png&quot;)</code>。可以使用copy-webpack-plugin将文件拷贝都当前工程中。</p>
<h3 id="Processing-css-loader-imports"><a href="#Processing-css-loader-imports" class="headerlink" title="Processing css-loader imports"></a>Processing css-loader imports</h3><p>importLoaders用于告诉webpack,通过imports引入的文件在经过css-loader处理后还需要经过多少个loader。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">  use: [</span><br><span class="line">    <span class="string">"style-loader"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">"css-loader"</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        importLoaders: <span class="number">1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"sass-loader"</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="Loading-from-node-modules"><a href="#Loading-from-node-modules" class="headerlink" title="Loading from node_modules"></a>Loading from node_modules</h3><p>当需要从node_modules引入文件时，需要使用<code>~</code>告诉webpack这里不是默认的相对引入，webpack就会去node_modules查找，查找node_modules是默认行为，可以通过设置<code>resolve.modules</code>修改。<br>如果使用了postcss-loader，可以不用使用<code>~</code>也能实现引入。</p>
<h3 id="Enabling-source-map"><a href="#Enabling-source-map" class="headerlink" title="Enabling source map"></a>Enabling source map</h3><blockquote>
<p>To use source maps, you have to enable sourceMap boolean through each style loader you are using except for style-loader. You should also set <code>output.publicPath</code> to an absolute url that points to your development server.</p>
</blockquote>
<h2 id="Separating-CSS"><a href="#Separating-CSS" class="headerlink" title="Separating CSS"></a>Separating CSS</h2><p>现在的项目已经可以应用样式了，但是存在FOUC(flush of unstyled content)样式闪动问题，因为现在的样式是嵌在JS中的，浏览器需要花时间来加载JS，JS加载好后才能展示样式，所以会出现样式闪动。<br>我们可以把样式分离出来，浏览器就可以分开处理样式和JS，这样能避免样式闪烁。<br>可以对比下分离CSS前和分离后：<br><img src="/2018/04/09/surviveJS-webpack-styling/normal.png" alt=""><br><img src="/2018/04/09/surviveJS-webpack-styling/extract-css.png" alt=""><br>我们可以使用<a href="https://www.npmjs.com/package/extract-text-webpack-plugin" target="_blank" rel="noopener">ExtractTextPlugin</a>来汇总所有的CSS并输出到一个文件中。这个过程需要一个Loader来抽取CSS，然后plugin取出Loader抽取的CSS，并输出到一个文件中。ExtractTextPlugin不支持HMR.</p>
<h3 id="Setting-up-ExtractTextPlugin"><a href="#Setting-up-ExtractTextPlugin" class="headerlink" title="Setting up ExtractTextPlugin"></a>Setting up ExtractTextPlugin</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add extract-text-webpack-plugin@next -D</span><br></pre></td></tr></table></figure>
<p>ExtractTextPlugin包含一个Loader:<code>ExtractTextPlugin.extract</code>用来标记需要抽取的assets，plugin会基于这些标记来继续抽取输出的工作。<br><code>ExtractTextPlugin.extract</code>接受use和fallback。ExtractTextPlugin默认只会用use中定义的loader处理initial chunks的内容，对于其他的chunks使用fallback。除非设置allChunks:true, 否则不会处理split bundles。<br>如果你想要抽取Sass这种CSS，就需要给use传递多个Loader. use和fallback都接受loader。<br>webpack.parts.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ExtractTextPlugin = <span class="built_in">require</span>(<span class="string">"extract-text-webpack-plugin"</span>);</span><br><span class="line"></span><br><span class="line">exports.extractCSS = <span class="function">(<span class="params">&#123; include, exclude, use &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Output extracted CSS to a file</span></span><br><span class="line">  <span class="keyword">const</span> plugin = <span class="keyword">new</span> ExtractTextPlugin(&#123;</span><br><span class="line">    <span class="comment">// `allChunks` is needed to extract from extracted chunks as well.</span></span><br><span class="line">    allChunks: <span class="literal">true</span>,</span><br><span class="line">    filename: <span class="string">"styles/[name].css"</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">      rules: [</span><br><span class="line">        &#123;</span><br><span class="line">          test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">          include,</span><br><span class="line">          exclude,</span><br><span class="line"></span><br><span class="line">          use: plugin.extract(&#123;</span><br><span class="line">            use,</span><br><span class="line">            fallback: <span class="string">"style-loader"</span>,</span><br><span class="line">          &#125;),</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [plugin],</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  parts.extractCSS(&#123;</span><br><span class="line">    use: <span class="string">"css-loader"</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> developmentConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parts.loadCSS(),</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/04/09/surviveJS-webpack-styling/extract-output.png" alt=""><br>在生产阶段将CSS抽取到一个文件中，JS bundle更小了，样式闪烁的问题也解决了。在开发阶段仍然使用普通的CSS加载方式，仍然可以享受HMR。</p>
<h2 id="Eliminating-Unused-CSS"><a href="#Eliminating-Unused-CSS" class="headerlink" title="Eliminating Unused CSS"></a>Eliminating Unused CSS</h2><p>一些CSS框架，比如bootstrap,你可能只是用了其中一小部分样式，但是打包的时候会将很多没用的样式都一起打包进来。我们希望能过滤一些无用的样式代码。<br><a href="https://www.npmjs.com/package/purifycss-webpack" target="_blank" rel="noopener">PurifyCSS</a> 可以通过分析文件实现这个功能。她会检查你的代码并找出哪些CSS classes是被使用了的。</p>
<blockquote>
<p>You have to be careful if you are using CSS Modules. You have to whitelist the related classes as discussed in purifycss-webpack readme.</p>
</blockquote>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>pure.css是一个小型的CSS库，我们可以引用这个库，再利用purifyCSS来过滤无用的CSS。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add pure.css</span><br></pre></td></tr></table></figure></p>
<p>index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"purecss"</span></span><br></pre></td></tr></table></figure></p>
<p>src/component.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (text = <span class="string">"Hello world"</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> element = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  element.className = <span class="string">"pure-button"</span>;</span><br><span class="line"></span><br><span class="line">  element.innerHTML = text;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>yarn run prod</code>查看下css文件大小：<br><img src="/2018/04/09/surviveJS-webpack-styling/nopurify.png" alt=""></p>
<p>引入purifycss<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add purifycss-webpack purify-css glob -D</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.npmjs.com/package/glob" target="_blank" rel="noopener">glob</a> match files using the patterns the shell uses, like stars and stuff.</p>
<p>webpack.parts.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PurifyCSSPlugin = <span class="built_in">require</span>(<span class="string">"purifycss-webpack"</span>);</span><br><span class="line"></span><br><span class="line">exports.purifyCSS = <span class="function">(<span class="params">&#123; paths &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  plugins: [<span class="keyword">new</span> PurifyCSSPlugin(&#123; paths &#125;)],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>需要注意的是：purifycss插件必须用在extractCSS插件后，不然就不起作用了<br>webpack.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> glob = <span class="built_in">require</span>(<span class="string">"glob"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PATHS = &#123;</span><br><span class="line">  app: path.join(__dirname, <span class="string">"src"</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  ...</span><br><span class="line">  parts.extractCSS(&#123;<span class="attr">use</span>:<span class="string">'css-loader'</span>&#125;),</span><br><span class="line">  <span class="comment">// Make sure this is after ExtractTextPlugin!</span></span><br><span class="line">  parts.purifyCSS(&#123;</span><br><span class="line">    <span class="comment">// Give paths to parse for rules. These should be absolute!</span></span><br><span class="line">    paths: glob.sync(<span class="string">`<span class="subst">$&#123;PATHS.app&#125;</span>/**/*.js`</span>, &#123; <span class="attr">nodir</span>: <span class="literal">true</span> &#125;),</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/04/09/surviveJS-webpack-styling/purifycss.png" alt=""><br>可以看到CSS文件的大小明显变小了。<br>purifyCSS还支持minify。可以通过给plugin传递purifyOptions配置。如果purifyCSS不能挑选出你使用的CSS classes，可以通过purifyOptions.whitelist数组来定义一些selectors，使得这些selectors不管在什么情况下都可以保留。</p>
<p>使用purifyCSS后会丢失CSS source maps，即使你给Loaders配置了开启source maps.</p>
<h3 id="Critical-path-rendering"><a href="#Critical-path-rendering" class="headerlink" title="Critical path rendering"></a>Critical path rendering</h3><blockquote>
<p>The idea of <strong><a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/" target="_blank" rel="noopener">critical path rendering</a></strong> takes a look at CSS performance from a different angle. Instead of optimizing for size, it optimizes for render order and emphasizes above-the-fold CSS. The result is achieved by rendering the page and then figuring out which rules are required to obtain the shown result.<br><code>webpack-critical</code> and <code>html-critical-webpack-plugin</code> implement the technique as a <code>HtmlWebpackPlugin</code>  plugin. <code>isomorphic-style-loader</code> achieves the same using webpack and React.<br>critical-path-css-tools by Addy Osmani lists other related tools.</p>
</blockquote>
<h2 id="Autoprefixing"><a href="#Autoprefixing" class="headerlink" title="Autoprefixing"></a>Autoprefixing</h2><p>自动添加前缀可以通过postCSS和autoprefixer插件实现。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add postcss-loader autoprefixer</span><br></pre></td></tr></table></figure></p>
<p>webpack.parts.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exports.autoprefix = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  loader: <span class="string">"postcss-loader"</span>,</span><br><span class="line">  options: &#123;</span><br><span class="line">    plugins: <span class="function"><span class="params">()</span> =&gt;</span> [<span class="built_in">require</span>(<span class="string">"autoprefixer"</span>)()],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>结合ExtractTextPlugin一起使用：<br>webpack.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  parts.extractCSS(&#123;</span><br><span class="line">   use: [<span class="string">"css-loader"</span>, parts.autoprefix()],</span><br><span class="line">  &#125;),</span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>如果你知道需要支持哪些浏览器，可以建一个<code>.browserslistrc</code>文件，autoprefixer和一些其他的工具都会用到这个件。<br>.browserslistrc<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; 1% # Browser usage over 1%</span><br><span class="line">Last 2 versions # Or last two versions</span><br><span class="line">IE 8 # Or IE 8</span><br></pre></td></tr></table></figure></p>
<p>app/main.css<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.pure-button</span> &#123;</span><br><span class="line">  <span class="attribute">-webkit-border-radius</span>: <span class="number">1em</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">1em</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译后的CSS文件是这样的：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.pure-button</span> &#123;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">1em</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>autoprefixer会删除一些不需要的规则，也会根据浏览器添加一些规则。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/05/surviveJS-webpack-developing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/05/surviveJS-webpack-developing/" itemprop="url">surviveJS-webpack-developing学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-05T22:42:07+08:00">2018-04-05</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/05/surviveJS-webpack-developing/" class="leancloud_visitors" data-flag-title="surviveJS-webpack-developing学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><a href="https://survivejs.com/webpack/developing/" target="_blank" rel="noopener">surviveJS-webpack-developing</a></strong></p>
<h1 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h1><h2 id="首先安装webpack"><a href="#首先安装webpack" class="headerlink" title="首先安装webpack"></a>首先安装webpack</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add webpack -D</span><br></pre></td></tr></table></figure>
<p>安装好webpack后，我们可以直接在控制台输入webpack，可以得到如下信息：<br><img src="/2018/04/05/surviveJS-webpack-developing/webpack-errors.png" alt=""><br>可以看到命令行提示我们安装webpack-cli，输入yes便可开始安装。安装完成后继续输入webpack:<br><img src="/2018/04/05/surviveJS-webpack-developing/webpack-console.png" alt=""><br>控制台的输出信息展示了：webpack的版本信息，hash信息以及编译时间和时长。</p>
<p>首先我们来看下第一个问题：<br>在控制台输入webpack执行了什么呢？<br>在控制台输入<code>yarn bin</code>,可以得到一条路径，一般是存放在node_modules/.bin目录下，进入.bin目录，可以看到如下的链接信息<br><img src="/2018/04/05/surviveJS-webpack-developing/webpack-bin.png" alt=""><br>进入webpack指向的文件,可以看到启动文件webpack.js如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runCommand</span>(<span class="params">command, options</span>) </span>&#123;</span><br><span class="line"><span class="comment">// install</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> webpackCliInstalled = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>.resolve(<span class="string">"webpack-cli"</span>);</span><br><span class="line">  webpackCliInstalled = <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  webpackCliInstalled = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!webpackCliInstalled) &#123;</span><br><span class="line">  <span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line">  <span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line">  <span class="keyword">const</span> readLine = <span class="built_in">require</span>(<span class="string">"readline"</span>);</span><br><span class="line">  <span class="keyword">const</span> isYarn = fs.existsSync(path.resolve(process.cwd(), <span class="string">"yarn.lock"</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> packageManager = isYarn ? <span class="string">"yarn"</span> : <span class="string">"npm"</span>;</span><br><span class="line">  <span class="keyword">const</span> options = [<span class="string">"install"</span>, <span class="string">"-D"</span>, <span class="string">"webpack-cli"</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isYarn) &#123;</span><br><span class="line">    options[<span class="number">0</span>] = <span class="string">"add"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> commandToBeRun = <span class="string">`<span class="subst">$&#123;packageManager&#125;</span> <span class="subst">$&#123;options.join(<span class="string">" "</span>)&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> question = <span class="string">`Would you like to install webpack-cli? (That will run <span class="subst">$&#123;commandToBeRun&#125;</span>) (yes/NO)`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">"The CLI moved into a separate package: webpack-cli"</span>);</span><br><span class="line">  <span class="keyword">const</span> questionInterface = readLine.createInterface(&#123;</span><br><span class="line">    input: process.stdin,</span><br><span class="line">    output: process.stdout</span><br><span class="line">  &#125;);</span><br><span class="line">  questionInterface.question(question, answer =&gt; &#123;</span><br><span class="line">    questionInterface.close();</span><br><span class="line">    <span class="keyword">switch</span> (answer.toLowerCase()) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"y"</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"yes"</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"1"</span>: &#123;</span><br><span class="line">        runCommand(packageManager, options)</span><br><span class="line">          .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">"webpack-cli"</span>); <span class="comment">//eslint-disable-line</span></span><br><span class="line">          &#125;)</span><br><span class="line">          .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(error);</span><br><span class="line">            process.exitCode = <span class="number">1</span>;</span><br><span class="line">          &#125;);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(</span><br><span class="line">          <span class="string">"It needs to be installed alongside webpack to use the CLI"</span></span><br><span class="line">        );</span><br><span class="line">        process.exitCode = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">"webpack-cli"</span>); <span class="comment">// eslint-disable-line</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到这个脚本主要内容就是加载webpack-cli，如果加载失败，输出错误信息，并引导用户安装webpack-cli。</p>
<p>然后我们来看截图中的问题：<br>首先是提示要指定mode，webpack新增指定mode为development或者production,会有一些默认的配置。这个warning可以通过运行<code>webpack --mode development</code>来解决。<br>第二个问题就是没有entry，即没有入口模块，下面开始添加入口。</p>
<h2 id="创建入口"><a href="#创建入口" class="headerlink" title="创建入口"></a>创建入口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn init -y</span><br></pre></td></tr></table></figure>
<p>建立package.json文件,配置scripts命令：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"scripts":&#123;</span><br><span class="line">  "prod": "webpack --mode production",</span><br><span class="line">  "dev": "webpack --mode development --devtool false"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>--devtool false</code>webpack会将生产的模板文件中的eval还原为原始代码。<br>然后新建两个测试文件</p>
<p>src/component.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (text = <span class="string">"Hello world"</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> element = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line"></span><br><span class="line">  element.innerHTML = text;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>src/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> component <span class="keyword">from</span> <span class="string">"./component"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(component());</span><br></pre></td></tr></table></figure></p>
<p>那么我们怎么在浏览器打开呢，还需要一个Html文件，我们可以使用html-webpack-plugin插件。<br>webpack.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins:[</span><br><span class="line">    <span class="keyword">new</span> HtmlWebpackPlugin(&#123;<span class="attr">title</span>:<span class="string">'webpack'</span>&#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行<code>yarn run prod</code>，在浏览器中打开Html文件，就可以看到Hello world了。</p>
<h2 id="分析webpack输出"><a href="#分析webpack输出" class="headerlink" title="分析webpack输出"></a>分析webpack输出</h2><p>运行<code>yarn run prod</code>后，控制台输出如下：<br><img src="/2018/04/05/surviveJS-webpack-developing/webpack-prod.png" alt=""><br>我们可以看下此时的输出bundle是什么样子的：<br><img src="/2018/04/05/surviveJS-webpack-developing/webpack-prod-bundle.png" alt=""><br>mode为production时，输出的bundle会被压缩。</p>
<p>接下来我们再运行下<code>yarn run dev</code>, 观察控制台输出：<br><img src="/2018/04/05/surviveJS-webpack-developing/webpack-dev.png" alt=""><br>在development模式下，会默认使用NameModulesPlugin,所以在Prod模式下的那些moduleId,chunkId现在都变成了names形式。同样看下输出的bundle:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123; <span class="comment">// webpackBootstrap</span></span><br><span class="line">  <span class="comment">// The module cache</span></span><br><span class="line">  <span class="keyword">var</span> installedModules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The require function</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Check if module is in cache</span></span><br><span class="line">    <span class="keyword">if</span>(installedModules[moduleId]) &#123;</span><br><span class="line">        <span class="keyword">return</span> installedModules[moduleId].exports;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Create a new module (and put it into the cache)</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = installedModules[moduleId] = &#123;</span><br><span class="line">        i: moduleId,</span><br><span class="line">        l: <span class="literal">false</span>,</span><br><span class="line">        exports: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Execute the module function</span></span><br><span class="line">    modules[moduleId].call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require__);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Flag the module as loaded</span></span><br><span class="line">    <span class="built_in">module</span>.l = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the exports of the module</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  __webpack_require__.xxx = xxx</span><br><span class="line"></span><br><span class="line">  <span class="comment">// __webpack_public_path__</span></span><br><span class="line">  __webpack_require__.p = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load entry module and return exports</span></span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="string">"./src/index.js"</span>);</span><br><span class="line">&#125;)</span><br><span class="line">(&#123;</span><br><span class="line"> <span class="string">"./src/component.js"</span>:(<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">  "use strict"</span>;</span><br><span class="line">  __webpack_require__.r(__webpack_exports__);</span><br><span class="line">  <span class="comment">/* harmony default export */</span> __webpack_exports__[<span class="string">"default"</span>] = <span class="function">(<span class="params">(text = <span class="string">"Hello world"</span></span>) =&gt;</span> &#123;<span class="comment">//component.js&#125;);</span></span><br><span class="line"> &#125;),</span><br><span class="line"> <span class="string">"./src/index.js"</span>: (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">  "use strict"</span>;</span><br><span class="line">  __webpack_require__.r(__webpack_exports__);</span><br><span class="line">    <span class="comment">/* harmony import */</span> <span class="keyword">var</span> _component__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(<span class="comment">/*! ./component */</span> <span class="string">"./src/component.js"</span>);</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(<span class="built_in">Object</span>(_component__WEBPACK_IMPORTED_MODULE_0__[<span class="string">"default"</span>])());</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>可以看到生成的bundle中其实就是一个即时函数，参数modules就是根据entry解析后所需要的模块。modules对象属性名为模块地址，属性值为一个函数，函数主体就是我们模块的主体，但是import,require都被替换成了<code>__webpack_require__</code>。<br>仔细看下这个<code>__webpack_require__</code>到底是做什么的？观察<code>__webpack_require__</code>函数，</p>
<ol>
<li>判断installedModules对象中是否存储了这个moduleId, 如果有，直接返回属性值的exports属性。</li>
<li>如果没有，则新建一个对象，<code>{i:moduleId, l:false, exports:{}}</code>, i表示id, l loaded表示是否加载，exports为空对象。 执行modules[moduleId]对应的函数，并传入<code>module, module.exports, __webpack_require__</code>，这就是为什么我们可以直接在文件中使用module,其实是webpack注入进来的。执行完对应的函数后，将loaded置为true，返回module.exports结果。</li>
</ol>
<p>至此，我们的demo已经可以打包运行了，但是每次修改还是需要手动运行，再刷新浏览器，下面我们就一起看看webpack-dev-server能否帮我们解决这个问题捏。</p>
<h1 id="webpack-dev-server"><a href="#webpack-dev-server" class="headerlink" title="webpack-dev-server"></a>webpack-dev-server</h1><h2 id="webpack-watch-mode"><a href="#webpack-watch-mode" class="headerlink" title="webpack watch mode"></a>webpack watch mode</h2><p>添加–watch参数，可以使webpack一直watching files，当文件改动时，可以自动编译， eg: <code>yarn run dev --watch</code>.<br>webpack-dev-server(WDS)也有watch的功能，并且更加强大。<br>WDS是运行在内存中的开发服务器，也就是说bundles不会输出到文件中，而是保存在内存中。WDS在你开发时，会监听文件的变化，自动编译自动刷新浏览器，并且支持webpack的热加载（HMR）功能。<br>虽然将文件保存在内存中，能提高性能，但有时候我们还是希望能输出到文件中，此时我们可以使用<code>write-file-webpack-plugin</code>插件。</p>
<p>##Getting started with WDS<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add webpack-dev-server -D</span><br></pre></td></tr></table></figure></p>
<p>package.json<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"start":"webpack-dev-server --mode development"</span><br></pre></td></tr></table></figure></p>
<p>运行<code>yarn start</code>,可以看到控制台输出<br><img src="/2018/04/05/surviveJS-webpack-developing/webpack-dev-server.png" alt=""><br>在浏览器中打开localhost:8080就可以看到Hello world的界面啦.</p>
<h2 id="configuring-WDS"><a href="#configuring-WDS" class="headerlink" title="configuring WDS"></a>configuring WDS</h2><p>webpack.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">  devServer: &#123;</span><br><span class="line">    <span class="comment">// Display only errors to reduce the amount of output.</span></span><br><span class="line">    stats: <span class="string">"errors-only"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse host and port from env to allow customization.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If you use Docker, Vagrant or Cloud9, set</span></span><br><span class="line">    <span class="comment">// host: options.host || "0.0.0.0";</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 0.0.0.0 is available to all network devices</span></span><br><span class="line">    <span class="comment">// unlike default `localhost`.</span></span><br><span class="line">    host: process.env.HOST, <span class="comment">// Defaults to `localhost`</span></span><br><span class="line">    port: process.env.PORT, <span class="comment">// Defaults to 8080</span></span><br><span class="line">    open: <span class="literal">true</span>, <span class="comment">// Open the page in browser</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这样配置后，可以通过<code>PORT=3000 yarn start</code>指定端口号。<br>虽然webpack-dev-server可以自动监听文件，但是却不能在webpack.config.js改变时，自动编译，我们只能在修改了配置后，重新启动服务才能生效。但是我们可以借助nodemon来监听webpack config file.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add nodemon -D</span><br></pre></td></tr></table></figure></p>
<p>package.json<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"start": "nodemon --watch webpack.config.js --exec \"webpack-dev-server --mode development\""</span><br></pre></td></tr></table></figure></p>
<p>修改webpack.config.js，webpack就能够自动重新编译啦。</p>
<h2 id="Polling-instead-of-watching-files"><a href="#Polling-instead-of-watching-files" class="headerlink" title="Polling instead of watching files"></a>Polling instead of watching files</h2><p>在一些旧版本的window,ubuntu,vagarant和docker上watch文件可能会失效，这个时候就可以允许Polling了。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">  watchOptions: &#123;</span><br><span class="line">    <span class="comment">// Delay the rebuild after the first change</span></span><br><span class="line">    aggregateTimeout: <span class="number">300</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Poll using interval (in ms, accepts boolean too)</span></span><br><span class="line">    poll: <span class="number">1000</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h2 id="other-features-of-webpack-dev-server"><a href="#other-features-of-webpack-dev-server" class="headerlink" title="other features of webpack-dev-server"></a>other features of webpack-dev-server</h2><ul>
<li>devServer.contentBase: 告诉服务器从哪里提供内容。只有在你想要提供静态文件时才需要。默认情况下，将使用当前工作目录作为提供内容的目录。</li>
<li>devServer.proxy:如果你有单独的后端开发服务器 API，并且希望在同域名下发送 API 请求 ，那么代理某些 URL 会很有用。<br><a href="https://www.webpackjs.com/configuration/dev-server/#devserver-proxy" target="_blank" rel="noopener">更多配置信息见官网</a></li>
</ul>
<h1 id="Composing-Configuration"><a href="#Composing-Configuration" class="headerlink" title="Composing Configuration"></a>Composing Configuration</h1><p>如果把我们的配置文件拆成很多部分，可以使用<code>webpack-merge</code>来将多个部分组合在一起：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add webpack-merge -D</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">merge = require(&apos;webpack-merge&apos;);</span><br><span class="line">merge(&#123;a:[1], b:2, c:3&#125;, &#123;a:[2], b:3, d:4&#125;)</span><br><span class="line">// &#123;a:[1,2], b:3, c:3, d:4&#125;</span><br></pre></td></tr></table></figure>
<p>对于这次的项目的配置文件，我们可以这样拆分组合：<br>webpack.parts.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">exports.devServer = <span class="function">(<span class="params">&#123; host, port &#125; = &#123;&#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    stats: <span class="string">"errors-only"</span>,</span><br><span class="line">    host, <span class="comment">// Defaults to `localhost`</span></span><br><span class="line">    port, <span class="comment">// Defaults to 8080</span></span><br><span class="line">    open: <span class="literal">true</span>,</span><br><span class="line">    overlay: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">"webpack-merge"</span>);</span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">"html-webpack-plugin"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> parts = <span class="built_in">require</span>(<span class="string">"./webpack.parts"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig = merge([</span><br><span class="line">  &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">        title: <span class="string">"Webpack demo"</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> productionConfig = merge([]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> developmentConfig = merge([</span><br><span class="line">  parts.devServer(&#123;</span><br><span class="line">    <span class="comment">// Customize host/port here if needed</span></span><br><span class="line">    host: process.env.HOST,</span><br><span class="line">    port: process.env.PORT,</span><br><span class="line">  &#125;),</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">mode</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (mode === <span class="string">"production"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> merge(commonConfig, productionConfig, &#123; mode &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> merge(commonConfig, developmentConfig, &#123; mode &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>配置文件最后直接返回了一个函数，接受cli传入的env. 这意味着package.json也应该有相应的修改：<br>package.json<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"start"</span>: <span class="string">"nodemon --watch webpack.config.js exec \"webpack-dev-server --env development\""</span>,</span><br><span class="line">  <span class="string">"build"</span>: <span class="string">"webpack --env production"</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/02/what-is-webpack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/02/what-is-webpack/" itemprop="url">what is webpack</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-02T19:27:50+08:00">2018-04-02</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/02/what-is-webpack/" class="leancloud_visitors" data-flag-title="what is webpack">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><a href="https://survivejs.com/webpack/what-is-webpack/" target="_blank" rel="noopener">what is webpack</a></strong>学习笔记。</p>
<p>webpack是一个模块打包工具，它依赖模块。即使是一个很小的项目，利用webpack来打包，一般会包括entry和Output.打包就是从用户自定义的entry开始进行的。entry本身也是模块，并且可以通过import导入其他的模块。当你使用webpack打包项目时，webpack会通过Import来构建项目的依赖图（dependency graph），并根据webpack配置输出output。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/26/http-hash-router/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/26/http-hash-router/" itemprop="url">http-hash-router source</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-26T15:18:06+08:00">2018-03-26</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sourcecode/" itemprop="url" rel="index"><span itemprop="name">sourcecode</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/03/26/http-hash-router/" class="leancloud_visitors" data-flag-title="http-hash-router source">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Server route handler for http-hash</p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HttpHashRouter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> hash = HttpHash();</span><br><span class="line"></span><br><span class="line">  handleRequest.hash = hash;</span><br><span class="line">  handleRequest.set = set;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> handleRequest;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">name, handler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (handler &amp;&amp; <span class="keyword">typeof</span> handler === <span class="string">'object'</span>) &#123;</span><br><span class="line">      handler = httpMethods(handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hash.set(name, handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleRequest</span>(<span class="params">req, res, opts, cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> cb !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExpectedCallbackError(&#123;</span><br><span class="line">        value: cb</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pathname = url.parse(req.url).pathname;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> route = hash.get(pathname);</span><br><span class="line">    <span class="keyword">if</span> (route.handler === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(NotFoundError(&#123;</span><br><span class="line">        pathname: pathname</span><br><span class="line">      &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    opts = extend(opts, &#123;</span><br><span class="line">      params: route.params,</span><br><span class="line">      splat: route.splat</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> route.handler(req, res, opts, cb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在httpHashRouter函数中会初始化一个http-hash实例hash，并且将hash绑定在返回的handleRequest函数上,同时还会绑定一个set方法。</p>
<h2 id="handleRequest-req-res-opts-cb"><a href="#handleRequest-req-res-opts-cb" class="headerlink" title="handleRequest(req, res, opts, cb)"></a>handleRequest(req, res, opts, cb)</h2><p>handleRequest是httpHashRouter返回的函数，接受四个参数，<br>第一二个参数分别为HTTPRequest和HTTPResponse;<br>第三个参数为Options对象;<br>第四个参数为callback，这个函数可能被传入http-hash-router.not-found error，或者是传递给route.handler,省略该参数, 会报http-hash-router.expected-callback异常。</p>
<p>handleRequest会根据req.url获取pathname,然后利用hash.get(pathname)获取解析后的route对象，根据<strong><a href="/2018/03/25/http-hash-source/">上一篇博文</a></strong>可以知道该对象结构为：<code>{handler, splat, params, src}</code>。如果route.handler为null，表示没有找到与当前路径匹配的路由。如果找到了对应的路由，则将params, splats复制到options参数上，调用route.handler.</p>
<p>总结：<br>handleRequest函数的作用其实就是从路由树中，找到匹配当前路径的节点，并通知handler。（handler是在hash.set(name, handler)时指定的）。</p>
<h2 id="set-name-handler"><a href="#set-name-handler" class="headerlink" title="set(name, handler)"></a>set(name, handler)</h2><p>调用set方法，会将传入的路由及其对应的handler存储在路由树中。<br>这里handler可以是函数或者对象，如果使用对象，会利用http-methods模块转为handler函数。<br>set方法实际上是使用的http-hash.set方法，可以通过<strong><a href="/2018/03/25/http-hash-source/">上一篇博文</a></strong>查看。<br>handler在调用时会传入四个参数，handler(req, res, opts, cb).</p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> HttpHashRouter = <span class="built_in">require</span>(<span class="string">'http-hash-router'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> router = HttpHashRouter();</span><br><span class="line"></span><br><span class="line">router.set(<span class="string">'/health'</span>, <span class="function"><span class="keyword">function</span> <span class="title">health</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.end(<span class="string">'OK'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> <span class="title">handler</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  router(req, res, &#123;&#125;, onError);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="comment">// use your own custom error serialization.</span></span><br><span class="line">      res.statusCode = err.statusCode || <span class="number">500</span>;</span><br><span class="line">      res.end(err.message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://github.com/Matt-Esch/http-hash-router" target="_blank" rel="noopener">http-hash-router github</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/25/http-hash-source/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/25/http-hash-source/" itemprop="url">http-hash source</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-25T10:47:04+08:00">2018-03-25</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sourcecode/" itemprop="url" rel="index"><span itemprop="name">sourcecode</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/03/25/http-hash-source/" class="leancloud_visitors" data-flag-title="http-hash source">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇笔记主要是记录下http-hash的源码。</p>
<blockquote>
<p>http-hash solves the routing problem by making route resolution independent of the order in which routes are defined. It does so by breaking a path into a tree of nodes, based on a simple split on /. For example, the route /foo/bar/baz is treated as tree nodes foo &gt; bar &gt; baz. We call foo, bar and baz path segments.</p>
</blockquote>
<h2 id="总体结构"><a href="#总体结构" class="headerlink" title="总体结构"></a>总体结构</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HttpHash</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> HttpHash)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HttpHash();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._hash = <span class="keyword">new</span> RouteNode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HttpHash.prototype.get = get;</span><br><span class="line">HttpHash.prototype.set = set;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>http-hash exports a safe constructor function that when called returns a new HttpHash. get and set methods are exposed for public consumption and the underlying data structure _hash is exposed for private inspection/internal use.</p>
</blockquote>
<h2 id="this-hash"><a href="#this-hash" class="headerlink" title="this._hash"></a>this._hash</h2><p>在http-hash的构造函数中，this._hash = new RouteNode()，那么this._hash到底是什么样的结构呢？我们看下RouteNode这个函数:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RouteNode</span>(<span class="params">parent, segment, isSplat</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.parent = parent || <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.segment = segment || <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.handler = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.staticPaths = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.variablePaths = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.isSplat = !!isSplat;</span><br><span class="line">  <span class="keyword">this</span>.src = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>this._hash初始化时，是没有给RouteNode传入任何参数的，所以<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>._hash = &#123;</span><br><span class="line">  parent: <span class="literal">null</span>,</span><br><span class="line">  segment: <span class="literal">null</span>,</span><br><span class="line">  handler: <span class="literal">null</span>,</span><br><span class="line">  staticPaths: &#123;&#125;,</span><br><span class="line">  variablePaths: <span class="literal">null</span>,</span><br><span class="line">  isSplat: <span class="literal">false</span>,</span><br><span class="line">  src: <span class="literal">null</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="set-pathname-handler"><a href="#set-pathname-handler" class="headerlink" title="set(pathname, handler)"></a>set(pathname, handler)</h2><p>接下来就是set方法了，set方法接收两个参数：pathname和handler<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">pathname, handler</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 分隔pathname，获取最后一级路径的位置；</span></span><br><span class="line">  <span class="comment">// 判断pathname中是否含有*</span></span><br><span class="line">  <span class="keyword">var</span> pathSegments = pathname.split(<span class="string">'/'</span>);</span><br><span class="line">  <span class="keyword">var</span> hash = <span class="keyword">this</span>._hash;</span><br><span class="line">  <span class="keyword">var</span> lastIndex = pathSegments.length - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> splatIndex = pathname.indexOf(<span class="string">'*'</span>);</span><br><span class="line">  <span class="keyword">var</span> hasSplat = splatIndex &gt;= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果pathname中有*，并且*号位置不在最后一级路径上，即不满足/p/a/t/h/*的路径，抛错</span></span><br><span class="line">  <span class="keyword">if</span> (hasSplat &amp;&amp; splatIndex !== pathname.length - <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> SplatError(pathname);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pathSegments.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> segment = pathSegments[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!segment) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasSplat &amp;&amp; i === lastIndex) &#123;</span><br><span class="line">      hash = (</span><br><span class="line">        hash.variablePaths ||</span><br><span class="line">        (hash.variablePaths = <span class="keyword">new</span> RouteNode(hash, segment, <span class="literal">true</span>))</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="comment">// /foo/:param 和 /foo/* 的情况</span></span><br><span class="line">      <span class="keyword">if</span> (!hash.isSplat) &#123;</span><br><span class="line">        <span class="keyword">throw</span> RouteConflictError(pathname, hash);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (segment.indexOf(<span class="string">':'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">      segment = segment.slice(<span class="number">1</span>);</span><br><span class="line">      hash = (</span><br><span class="line">        hash.variablePaths ||</span><br><span class="line">        (hash.variablePaths = <span class="keyword">new</span> RouteNode(hash, segment))</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="comment">// /foo/:param1 和 /foo/:param2</span></span><br><span class="line">      <span class="comment">// /foo/* 和 /foo/:param 两种冲突情况</span></span><br><span class="line">      <span class="keyword">if</span> (hash.segment !== segment || hash.isSplat) &#123;</span><br><span class="line">        <span class="keyword">throw</span> RouteConflictError(pathname, hash);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (segment === <span class="string">'__proto__'</span>) &#123;</span><br><span class="line">      hash = (</span><br><span class="line">        (</span><br><span class="line">          hash.hasOwnProperty(<span class="string">'proto'</span>) &amp;&amp;</span><br><span class="line">          hash.proto</span><br><span class="line">        ) ||</span><br><span class="line">        (hash.proto = <span class="keyword">new</span> RouteNode(hash, segment))</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      hash = (</span><br><span class="line">        (</span><br><span class="line">          hash.staticPaths.hasOwnProperty(segment) &amp;&amp;</span><br><span class="line">          hash.staticPaths[segment]</span><br><span class="line">        ) ||</span><br><span class="line">        (hash.staticPaths[segment] = <span class="keyword">new</span> RouteNode(hash, segment))</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hash.handler === <span class="literal">null</span>) &#123;</span><br><span class="line">    hash.src = pathname;</span><br><span class="line">    hash.handler = handler;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 同一路径，不同handler冲突</span></span><br><span class="line">    throwRouteConflictError(pathname, hash);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在set函数主体的for循环中，会对每一级路径进行判断</p>
<ul>
<li>如果pathname中有*，且循环到了最后一级路径，先检查当前hash是否存在variablePaths, 如果不存在hash.variablePaths赋值new RouteNode(hash, segment, true)</li>
<li>如果当前这级路径含有:，去掉:，取变量名，当前hash不存在variablePaths，给hash.variablePaths赋值</li>
<li>如果当前路径为<em>proto</em>，当hash有proto属性，并且proto属性存在时，不做处理，否则赋值new RouteNode(hash, segment)</li>
<li>以上情况都不满足时，就认为是普通路径，检查hash.staticPaths是否存在【segment】属性，不存在时，赋值new RouteNode(hash, segment)<br>最后会把hash.src赋值为pathname，hash.handler赋值为传入的handler</li>
</ul>
<p>下面是用树状图画的这个赋值过程，假设set(‘/foo/bar/:param/*’,emptyFunc);<br><img src="/2018/03/25/http-hash-source/xmind.png" alt=""><br>上面这个树状图很清楚的表现了set后的对象结构，非变量路径存放在staticPath下，变量形式的路径存放在variablePaths下。</p>
<h2 id="get-pathname"><a href="#get-pathname" class="headerlink" title="get(pathname)"></a>get(pathname)</h2><p>最后我们再看下get方法<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">pathname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> pathSegments = pathname.split(<span class="string">'/'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> hash = <span class="keyword">this</span>._hash;</span><br><span class="line">  <span class="keyword">var</span> splat = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> params = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> variablePaths;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pathSegments.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> segment = pathSegments[i];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 匹配 ’‘ 或者 多个/ eg: ///</span></span><br><span class="line">    <span class="keyword">if</span> (!segment &amp;&amp; !hash.isSplat) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="comment">// 优先匹配_proto_</span></span><br><span class="line">      segment === <span class="string">'__proto__'</span> &amp;&amp;</span><br><span class="line">      hash.hasOwnProperty(<span class="string">'proto'</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      hash = hash.proto;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hash.staticPaths.hasOwnProperty(segment)) &#123; <span class="comment">// 其次是staticPaths</span></span><br><span class="line">      hash = hash.staticPaths[segment];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((variablePaths = hash.variablePaths)) &#123; <span class="comment">// 接下来是variablePath</span></span><br><span class="line">      <span class="comment">// 如果isSplat标记为true，表示*匹配，则将pathSegments后面的路径用/拼接，循环终止</span></span><br><span class="line">      <span class="comment">// 否则表示是:param匹配，存在params对象中</span></span><br><span class="line">      <span class="keyword">if</span> (variablePaths.isSplat) &#123;</span><br><span class="line">        splat = pathSegments.slice(i).join(<span class="string">'/'</span>);</span><br><span class="line">        hash = variablePaths;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        params[variablePaths.segment] = segment;</span><br><span class="line">        hash = variablePaths;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      hash = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当hash还存在下一级树形结构*，但是并没有匹配到时，eg:/foo/bar/test</span></span><br><span class="line">  <span class="keyword">if</span> (hash &amp;&amp;</span><br><span class="line">    hash.handler === <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    hash.variablePaths &amp;&amp;</span><br><span class="line">    hash.variablePaths.isSplat</span><br><span class="line">  ) &#123;</span><br><span class="line">    splat = <span class="string">''</span>;</span><br><span class="line">    hash = hash.variablePaths;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RouteResult(hash, params, splat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里以<code>get(&#39;/foo/bar/test/p/a/t/h&#39;)</code>为例：</p>
<ol>
<li>以/为标志分隔字符串<br><code>pathSegments = [&#39;&#39;,&#39;foo&#39;,&#39;bar&#39;,&#39;test&#39;,&#39;p&#39;.&#39;a&#39;,&#39;t&#39;,&#39;h&#39;]</code><br>这里的this._hash是上图中的结构</li>
<li>这里数组中第一个元素为空已经跳过循环，数组中不存在<em>proto</em>，开始检查hash.staticPaths,从上图可以看到<code>hash.staticPaths={foo:{...}}</code>结构，所以<br><code>hash = this._hash.staticPaths.foo</code>,<br>后面的bar也是存放在staticPaths下面的，因此<br><code>hash = this._hash.staticPaths.foo.staticPaths.bar</code></li>
<li>循环到test时，<code>hash.staticPaths={}</code>, 查看variablePaths, 当前variablePaths.isSplat为false，进入else分支，<br><code>params.param = test</code>,<br><code>hash = this._hash.staticPaths.foo.staticPaths.bar.variablePaths</code></li>
<li><p>循环到p时， <code>hash.staticPaths ={}</code>,查看hash.variablePaths结构如下，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hash.variablePaths=&#123;</span><br><span class="line">  segment:*,</span><br><span class="line">  handler:emptyFunc,</span><br><span class="line">  isSpat:true,</span><br><span class="line">  src:&apos;/foo/bar/:params/*&apos;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以<code>splat=&#39;p/a/t/h&#39;</code>,<br><code>hash = this._hash.staticPaths.foo.staticPaths.bar.variablePaths.variablePaths</code></p>
</li>
<li>返回RouteResult实例,<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  handler: handler,</span><br><span class="line">  splat: &apos;p/a/t/h&apos;,</span><br><span class="line">  params: &#123;param:test&#125;,</span><br><span class="line">  src: &apos;/foo/bar/:param/*</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>RouteResult函数如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RouteResult</span>(<span class="params">node, params, splat</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.handler = node &amp;&amp; node.handler || <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.splat = splat;</span><br><span class="line">  <span class="keyword">this</span>.params = params;</span><br><span class="line">  <span class="keyword">this</span>.src = node &amp;&amp; node.src || <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Since a node can have both static and dynamic paths associated with it, the static path will win over the variable path when we resolve the path.</p>
</blockquote>
<h2 id="Path-Conflicts"><a href="#Path-Conflicts" class="headerlink" title="Path Conflicts"></a>Path Conflicts</h2><p>如果有路由冲突，程序会抛出异常。下面说一下冲突的发生：</p>
<ol>
<li>同一个路径，定义了不同的handler</li>
<li>路径的变量名不一致<br>eg: /foo/:vara/ 和 /foo/:varb/ 冲突，因为都能匹配foo.variablePaths, 却有不同的param names。</li>
<li>A variable route is defined for a splat node<br>当splats和变量路径定义在同一等级上，比如/foo/:var 和 /foo/<em> 这样就会有冲突<br>但如果是静态路径和splat在同一级上就没有问题，eg: /foo/bar 和 /foo/</em>，这种情况下静态路径的优先级高于splat</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://github.com/Matt-Esch/http-hash" target="_blank" rel="noopener">http-hash github</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Ailsa" />
            
              <p class="site-author-name" itemprop="name">Ailsa</p>
              <p class="site-description motion-element" itemprop="description">Front End Engineer</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ailsa</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.6</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.6"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.6"></script>



  



	





  





  










  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("1nV85N21T6AO0avUlypxP9SI-gzGzoHsz", "wtpWsIgedu3sVOq1dgtWUiix");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
            counter.save(null, {
              success: function(counter) {
                
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.get('time'));
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  
  

  

  

  

  

</body>
</html>
