<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.6" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/html_small.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/html_big.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/html_big.png?v=6.0.6">


  <link rel="mask-icon" href="/images/html.svg?v=6.0.6" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.6',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="surviveJS-webpack-optimizing Minifyingwebpack4 mode为production时，默认会使用UglifyJS来压缩代码。压缩代码就是把代码转换为体积更小的形式。安全转换在压缩代码的同时不会改变代码的作用，比如重命名变量名或者删除一些不可能执行的代码（if(false)）。非安全转换可能会破坏代码，因为可能会丢失底层代码隐含的某些内容，比如angular">
<meta property="og:type" content="article">
<meta property="og:title" content="surviveJS-webpack-optimizing 学习笔记">
<meta property="og:url" content="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/index.html">
<meta property="og:site_name" content="Ailsa&#39;s blog">
<meta property="og:description" content="surviveJS-webpack-optimizing Minifyingwebpack4 mode为production时，默认会使用UglifyJS来压缩代码。压缩代码就是把代码转换为体积更小的形式。安全转换在压缩代码的同时不会改变代码的作用，比如重命名变量名或者删除一些不可能执行的代码（if(false)）。非安全转换可能会破坏代码，因为可能会丢失底层代码隐含的某些内容，比如angular">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/minifycss1.png">
<meta property="og:image" content="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/minifycss2.png">
<meta property="og:image" content="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/minifycss3.png">
<meta property="og:image" content="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/minifycss4.png">
<meta property="og:image" content="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/treeshake1.png">
<meta property="og:image" content="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/hash1.png">
<meta property="og:updated_time" content="2018-05-07T06:56:35.324Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="surviveJS-webpack-optimizing 学习笔记">
<meta name="twitter:description" content="surviveJS-webpack-optimizing Minifyingwebpack4 mode为production时，默认会使用UglifyJS来压缩代码。压缩代码就是把代码转换为体积更小的形式。安全转换在压缩代码的同时不会改变代码的作用，比如重命名变量名或者删除一些不可能执行的代码（if(false)）。非安全转换可能会破坏代码，因为可能会丢失底层代码隐含的某些内容，比如angular">
<meta name="twitter:image" content="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/minifycss1.png">






  <link rel="canonical" href="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>surviveJS-webpack-optimizing 学习笔记 | Ailsa's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ailsa's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Front End Engineer</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
</li>

      

      
    </ul>
  

  
    

  

  
</nav>


  



 </div>
    </header>

    
  
  
  
    
      
    
    <a href="https://github.com/Yangqin0607" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg>
    
      </a>
    



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/04/surviveJS-webpack-optimizing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ailsa">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ailsa's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">surviveJS-webpack-optimizing 学习笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-04T16:18:21+08:00">2018-05-04</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/04/surviveJS-webpack-optimizing/" class="leancloud_visitors" data-flag-title="surviveJS-webpack-optimizing 学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong><a href="https://survivejs.com/webpack/optimizing/" target="_blank" rel="noopener">surviveJS-webpack-optimizing</a></strong></p>
<h1 id="Minifying"><a href="#Minifying" class="headerlink" title="Minifying"></a>Minifying</h1><p>webpack4 mode为production时，默认会使用UglifyJS来压缩代码。压缩代码就是把代码转换为体积更小的形式。安全转换在压缩代码的同时不会改变代码的作用，比如重命名变量名或者删除一些不可能执行的代码（if(false)）。非安全转换可能会破坏代码，因为可能会丢失底层代码隐含的某些内容，比如angular1 使用模块时，函数变量名是特定的，改写变量名就会破坏代码功能。</p>
<h2 id="Modifying-JavaScript-Minification-Process"><a href="#Modifying-JavaScript-Minification-Process" class="headerlink" title="Modifying JavaScript Minification Process"></a>Modifying JavaScript Minification Process</h2><p>webpack4 中提供了两个配置项来控制压缩过程：<code>optimization.minimize</code>来开关压缩功能，<code>optimization.minimizer</code>数组来配置过程。<br>为了调整默认行为，我们添加<code>uglifyjs-webpack-plugin</code>到我们的例子中。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add uglifyjs-webpack-plugin -D</span><br></pre></td></tr></table></figure></p>
<p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UglifyWebpackPlugin = <span class="built_in">require</span>(<span class="string">"uglifyjs-webpack-plugin"</span>);</span><br><span class="line"></span><br><span class="line">exports.minifyJavaScript = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    minimizer: [<span class="keyword">new</span> UglifyWebpackPlugin(&#123; <span class="attr">sourceMap</span>: <span class="literal">true</span> &#125;)],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  parts.clean(PATHS.build),</span><br><span class="line"></span><br><span class="line">  parts.minifyJavaScript(),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>编译后结果应该跟之前一样，但是通过这种方式使用的是最新的UglifyJS版本。<br>source map默认是关闭的，可以通过sourceMap开启。如果需要在打包后的代码中删除console.log，可以设置<code>uglifyOptions.compress.drop_console</code>为true。</p>
<h2 id="Speeding-Up-JavaScript-Execution"><a href="#Speeding-Up-JavaScript-Execution" class="headerlink" title="Speeding Up JavaScript Execution"></a>Speeding Up JavaScript Execution</h2><blockquote>
<p>Specific solutions allow you to preprocess code so that it will run faster. They complement the minification technique and can be split into scope hoisting, pre-evaluation, and improving parsing. It’s possible these techniques grow overall bundle size sometimes while allowing faster execution.</p>
</blockquote>
<h3 id="scope-hoisting"><a href="#scope-hoisting" class="headerlink" title="scope hoisting"></a>scope hoisting</h3><p>webpack 4 在生产模式自动应用了scope hoisting。过去 webpack 打包时将 bundle 中各个模块单独打包成闭包。这些打包函数使你的 JavaScript 在浏览器中处理的更慢。相比之下，一些工具像 Closure Compiler 和 RollupJS 可以提升(hoist)或者预编译所有模块到一个闭包中，提升你的代码在浏览器中的执行速度。<a href="https://medium.com/webpack/brief-introduction-to-scope-hoisting-in-webpack-8435084c171f" target="_blank" rel="noopener">webpack scope hositing 博客</a></p>
<p>在<a href="http://yangqin0607.coding.me/2018/04/05/surviveJS-webpack-developing/" target="_blank" rel="noopener">developing学习笔记</a>中，我们看了webpack输出的打包文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123; <span class="comment">// webpackBootstrap</span></span><br><span class="line">  <span class="comment">// The module cache</span></span><br><span class="line">  <span class="keyword">var</span> installedModules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The require function</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">      </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  __webpack_require__.xxx = xxx</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// __webpack_public_path__</span></span><br><span class="line">  __webpack_require__.p = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load entry module and return exports</span></span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="string">"./src/index.js"</span>);</span><br><span class="line">&#125;)</span><br><span class="line">(&#123;</span><br><span class="line"> <span class="string">"./src/component.js"</span>:(<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123; &#125;),</span><br><span class="line"> <span class="string">"./src/index.js"</span>: (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123; &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如下，没有使用scope hoisting的时候，index.js中引入component.js时，会使用<code>_webpack_require_(&quot;./src/component.js&quot;)</code>,然后我们开启下scope hoisting，对比下webpack会怎么处理component.js。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">  "use strict"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> _component = __webpack_require__(<span class="comment">/*! ./component */</span> <span class="string">"./src/component.js"</span>);</span><br><span class="line">  <span class="keyword">var</span> _component2 = _interopRequireDefault(_component);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123; <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="attr">default</span>: obj &#125;; &#125;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild((<span class="number">0</span>, _component2.default)());</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure>
<p>由于实现 ECMAScript 模块语法,scope hoisting这个特定于此语法的功能才成为可能。webpack 可能会根据你正在使用的模块类型和其他的情况，回退到普通打包。此插件仅适用于由 webpack 直接处理的 ES6 模块。在使用转译器(transpiler)时，你需要禁用对模块的处理（例如 Babel 中的 modules 选项）。所以开启scope hoisting，还需要在.babelrc中设置<code>{modules:false}</code>，禁用对模块的处理。<br>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exports.hoistCode = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  plugins: [<span class="keyword">new</span> webpack.optimize.ModuleConcatenationPlugin()]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>.babelrc<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>:[</span><br><span class="line">    [</span><br><span class="line">      <span class="string">"env"</span>,</span><br><span class="line">      &#123;<span class="attr">"modules"</span>:<span class="literal">false</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>开启scope hoisting，index.js打包内容如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">  "use strict"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// CONCATENATED MODULE: ./src/component.js</span></span><br><span class="line">  <span class="comment">/* harmony default export */</span> <span class="keyword">var</span> component = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> text = <span class="built_in">arguments</span>.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">arguments</span>[<span class="number">0</span>] !== <span class="literal">undefined</span> ? <span class="built_in">arguments</span>[<span class="number">0</span>] : <span class="string">'Hello world'</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">var</span> element = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">    element.innerHTML = text;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">    &#125;);</span><br><span class="line">  <span class="keyword">var</span> a = <span class="string">"123"</span>;</span><br><span class="line">  <span class="comment">// CONCATENATED MODULE: ./src/index.js</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(component());</span><br><span class="line"></span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure></p>
<p>可以看到component.js直接被引入到了index.js中，而不是单独封装了。<br>给webpack传递<code>--display-optimization-bailout</code>标志，可以debug跟scope hoisting相关的信息。</p>
<h3 id="pre-evaluation"><a href="#pre-evaluation" class="headerlink" title="pre-evaluation"></a>pre-evaluation</h3><p><a href="https://www.npmjs.com/package/prepack-webpack-plugin" target="_blank" rel="noopener"><code>prepack-webpack-plugin</code></a>会在编译阶段做一些计算，从而加快代码执行时速度。该插件使用的是<a href="https://prepack.io/" target="_blank" rel="noopener">Prepack</a>。举个简单的例子：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="string">'hello'</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">world</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="string">'world'</span>; &#125;</span><br><span class="line">  global.s = hello() + <span class="string">' '</span> + world();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<p>用prepack编译后为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">"hello world"</span>;</span><br></pre></td></tr></table></figure></p>
<p>但是这个plugin跟旧的webpack有冲突，<a href="https://github.com/gajus/prepack-loader/issues/2" target="_blank" rel="noopener">issues</a>。类似的工具还有：<code>val-loader</code> and <code>babel-plugin-preval</code></p>
<h2 id="Minifying-HTML"><a href="#Minifying-HTML" class="headerlink" title="Minifying HTML"></a>Minifying HTML</h2><blockquote>
<p>If you consume HTML templates through your code using html-loader, you can preprocess it through posthtml with posthtml-loader. You can use posthtml-minifier to minify your HTML through it.</p>
</blockquote>
<h2 id="Minifying-CSS"><a href="#Minifying-CSS" class="headerlink" title="Minifying CSS"></a>Minifying CSS</h2><p><code>css-loader</code>允许通过<a href="http://cssnano.co/guides/getting-started/" target="_blank" rel="noopener">cssnano</a>来压缩css，需要通过minimize显式开启压缩功能。也可以给cssnano<a href="http://cssnano.co/optimisations/" target="_blank" rel="noopener">传参</a>来定制压缩行为。<br><code>clean-css-loader</code>允许使用css压缩工具<code>clean-css</code>.<br><code>optimize-css-assets-webpack-plugin</code>能压缩css输出。使用<code>ExtractTextPlugin</code>会导致重复的CSS,因为它只是合并text chunks。<code>optimize-css-assets-webpack-plugin</code>不会产生这个问题。</p>
<p>在这些可选的方案中，<code>optimize-css-assets-webpack-plugin</code>比较好用，下面我们试用一下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add optimize-css-assets-webpack-plugin cssnano -D</span><br></pre></td></tr></table></figure></p>
<p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> OptimizeCSSAssetsPlugin = <span class="built_in">require</span>(</span><br><span class="line">  <span class="string">"optimize-css-assets-webpack-plugin"</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">const</span> cssnano = <span class="built_in">require</span>(<span class="string">"cssnano"</span>);</span><br><span class="line"></span><br><span class="line">exports.minifyCSS = <span class="function">(<span class="params">&#123; options &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> OptimizeCSSAssetsPlugin(&#123;</span><br><span class="line">      cssProcessor: cssnano,</span><br><span class="line">      cssProcessorOptions: options,</span><br><span class="line">      canPrint: <span class="literal">false</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>如果我们要使用–json，比如<code>webpack --env production --json &gt; stats.json</code>,需要设置<code>canPrint:false</code>。<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line">  ...</span><br><span class="line">  parts.minifyJavaScript(),</span><br><span class="line"></span><br><span class="line">  parts.minifyCSS(&#123;</span><br><span class="line">    options: &#123;</span><br><span class="line">      discardComments: &#123;</span><br><span class="line">        removeAll: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// Run cssnano in safe mode to avoid</span></span><br><span class="line">      <span class="comment">// potentially unsafe transformations.</span></span><br><span class="line">      safe: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>配置前</th>
<th style="text-align:center">配置后</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/2018/05/04/surviveJS-webpack-optimizing/minifycss1.png" alt=""></td>
<td style="text-align:center"><img src="/2018/05/04/surviveJS-webpack-optimizing/minifycss2.png" alt=""></td>
<td>两个body样式合并到了一起</td>
</tr>
<tr>
<td><img src="/2018/05/04/surviveJS-webpack-optimizing/minifycss3.png" alt=""></td>
<td style="text-align:center"><img src="/2018/05/04/surviveJS-webpack-optimizing/minifycss4.png" alt=""></td>
<td>css文件缩小了</td>
</tr>
</tbody>
</table>
<h2 id="Minifying-Images"><a href="#Minifying-Images" class="headerlink" title="Minifying Images"></a>Minifying Images</h2><blockquote>
<p>Image size can be reduced by using img-loader, imagemin-webpack, and imagemin-webpack-plugin. The packages use image optimizers underneath.</p>
</blockquote>
<blockquote>
<p>It can be a good idea to use cache-loader and thread-loader with these as discussed in the Performance chapter given they can be substantial operations.</p>
</blockquote>
<h1 id="Tree-Shaking"><a href="#Tree-Shaking" class="headerlink" title="Tree Shaking"></a>Tree Shaking</h1><p>tree shaking 是一个术语，通常用于描述移除 JavaScript 上下文中的未引用代码(dead-code)。它依赖于 ES2015 模块系统中的<a href="http://exploringjs.com/es6/ch_modules.html#static-module-structure" target="_blank" rel="noopener">静态结构特性</a>，例如 import 和 export。因此我们需要配置babel的<code>modules:false</code>。</p>
<h2 id="Demonstrating-Tree-Shaking"><a href="#Demonstrating-Tree-Shaking" class="headerlink" title="Demonstrating Tree Shaking"></a>Demonstrating Tree Shaking</h2><p>src/shake.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shake = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"shake"</span>);</span><br><span class="line"><span class="keyword">const</span> bake = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"bake"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; shake, bake &#125;;</span><br></pre></td></tr></table></figure></p>
<p>src/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bake &#125; <span class="keyword">from</span> <span class="string">"./shake"</span>;</span><br><span class="line"></span><br><span class="line">bake();</span><br></pre></td></tr></table></figure></p>
<p><code>yarn run prod</code>编译文件，在dist/main.js中搜索’shake’，会发现找不到，因为被删掉了。我们还可以通过<code>yarn run prod --display-used-exports</code>来查看shake信息。<br><img src="/2018/05/04/surviveJS-webpack-optimizing/treeshake1.png" alt=""></p>
<p>这里我们直接就可以shake unused code，是因为webpack 4的生产环境默认使用了<code>uglifyJSPlugin</code>。另外需要shake 无用的css modules的话，可以使用<a href="https://github.com/simlrh/dead-css-loader" target="_blank" rel="noopener">dead-css-loader</a>;</p>
<h2 id="Tree-Shaking-on-Package-Level"><a href="#Tree-Shaking-on-Package-Level" class="headerlink" title="Tree Shaking on Package Level"></a>Tree Shaking on Package Level</h2><p>为了能正常使用webpack的tree shaking，我们需要让webpack自己处理ES2015的modules，在babel的配置中，设置<code>modules:false</code>。此外为了能shake外部依赖，我们可以使用<a href="https://www.npmjs.com/package/babel-plugin-transform-imports" target="_blank" rel="noopener"><code>babel-plugin-transform-imports</code></a>重写imports,如下面这种方式<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Row, Grid <span class="keyword">as</span> MyGrid &#125; <span class="keyword">from</span> <span class="string">'react-bootstrap'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; merge &#125; <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br></pre></td></tr></table></figure></p>
<p>修改为下面这种方式引入<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Row <span class="keyword">from</span> <span class="string">'react-bootstrap/lib/Row'</span>;</span><br><span class="line"><span class="keyword">import</span> MyGrid <span class="keyword">from</span> <span class="string">'react-bootstrap/lib/Grid'</span>;</span><br><span class="line"><span class="keyword">import</span> merge <span class="keyword">from</span> <span class="string">'lodash/merge'</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><blockquote>
<p>Tree shaking is a potentially powerful technique. For the source to benefit from tree shaking, npm packages have to be implemented using the ES2015 module syntax, and they have to expose the ES2015 version through package.json module field tools like webpack can pick up.</p>
</blockquote>
<blockquote>
<p>As a package author, you can provide a version of your package that contains ES2015 modules, while the rest has been transpiled to ES5. <a href="https://www.webpackjs.com/guides/tree-shaking/#%E5%B0%86%E6%96%87%E4%BB%B6%E6%A0%87%E8%AE%B0%E4%B8%BA%E6%97%A0%E5%89%AF%E4%BD%9C%E7%94%A8-side-effect-free-" target="_blank" rel="noopener">Set sideEffect for package.json</a><br>eg: ramda package.json <code>side-effects:false</code></p>
</blockquote>
<h1 id="Environment-Variables"><a href="#Environment-Variables" class="headerlink" title="Environment Variables"></a>Environment Variables</h1><p>之前说过压缩Javascript代码时，会移除dead code (if(false))。webpack的<code>DefinePlugin</code>允许替换自由变量，这样我们就可以将<code>if (process.env.NODE_ENV === &quot;development&quot;)</code>这类代码根据当前环境转换为<code>if (true)</code>或者<code>if (false)</code>。<br>webpack 4会根据提供的mode来设置<code>process.env.NODE_ENV</code>,但我们有必要了解一下这方面的知识。</p>
<h2 id="The-Basic-Idea-of-DefinePlugin"><a href="#The-Basic-Idea-of-DefinePlugin" class="headerlink" title="The Basic Idea of DefinePlugin"></a>The Basic Idea of DefinePlugin</h2><p>我们先来看个例子：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Not free due to "foo" above, not ok to replace</span></span><br><span class="line"><span class="keyword">if</span> (foo === <span class="string">"bar"</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"bar"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Free since you don't refer to "bar", ok to replace</span></span><br><span class="line"><span class="keyword">if</span> (bar === <span class="string">"bar"</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"bar"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在上面这个例子中foo变量，一开始已经定义过了，所以不是自由变量，但是下面的bar，上下文中并没有定义，属于自由变量，如果在DefinePlugin中定义了这个变量，就会用DefinePlugin中定义的值来替换bar。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">"foobar"</span> === <span class="string">"bar"</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"bar"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里进一步分析就知道<code>&quot;foobar&quot; === &quot;bar&quot;</code>的值为false，所以这段代码就可以替换为<code>if(false)</code>即dead 代码，被shake掉。</p>
<h2 id="using-DefinePlugin"><a href="#using-DefinePlugin" class="headerlink" title="using DefinePlugin"></a>using DefinePlugin</h2><p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"></span><br><span class="line">exports.setFreeVariable = <span class="function">(<span class="params">key, value</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> env = &#123;&#125;;</span><br><span class="line">  env[key] = <span class="built_in">JSON</span>.stringify(value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    plugins: [<span class="keyword">new</span> webpack.DefinePlugin(env)],</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commonConfig = merge([</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parts.setFreeVariable(<span class="string">"HELLO"</span>, <span class="string">"hello from config"</span>),</span><br><span class="line"></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>src/component.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (text = HELLO) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> element = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>如果不使用DefinePlugin定义HELLO，运行的时候会报错，HELLO is not defined。使用DefinePlugin定以后，HELLO为自由变量，会去寻找DefinePlugin是否需要替换这个变量，所以按钮的文案替换为了<code>hello from config</code>。<br><a href="https://www.npmjs.com/package/webpack-conditional-loader" target="_blank" rel="noopener">webpack-conditional-loader</a>根据代码注释做相似的操作，但是可以删掉整个dead code，这样能使你的bundle更小，应用加载也更快。</p>
<p><code>webpack.EnvironmentPlugin([&quot;NODE_ENV&quot;])</code>插件也可以引用环境变量，底层实现依赖DefinePlugin，也可以使用<code>process.env.NODE_ENV</code>实现。</p>
<h2 id="Choosing-Which-Module-to-Use"><a href="#Choosing-Which-Module-to-Use" class="headerlink" title="Choosing Which Module to Use"></a>Choosing Which Module to Use</h2><p>本章讨论的技术可以用来根据环境选择加载某个模块。正如上面的示例看到的，DefinePlugin可以决定使用哪些代码，丢弃哪些代码。我们也可以把这种思想用在模块加载上，比如index.js中需要根据环境来加载不同的文件，就可以这样写:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">"production"</span>) &#123;</span><br><span class="line">  <span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">"./store.prod"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">"./store.dev"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Adding-Hashes-to-Filenames"><a href="#Adding-Hashes-to-Filenames" class="headerlink" title="Adding Hashes to Filenames"></a>Adding Hashes to Filenames</h1><p>现在我们的示例中编译后的文件都以文件名来命名，这样就不能有效的利用客户端缓存，因为客户端无法根据文件名来区分这个文件是否改变，我们可以通过在文件名中加入hash来利用缓存。</p>
<h2 id="placeholders"><a href="#placeholders" class="headerlink" title="placeholders"></a>placeholders</h2><p>webpack提供了一些placeholders，这些字符串会将相关的信息附加在webpack的输出上：</p>
<ul>
<li>[id]: 返回chunk id</li>
<li>[path]: 返回文件路径</li>
<li>[name]: 返回文件名</li>
<li>[ext]: 返回扩展名。大部分情况下是可用的，但MiniCssExtractPlugin是个例外。</li>
<li>[hash]: 返回编译哈希。如果编译生成的任何部分发生变化，hash值也会发生变化。</li>
<li>[chunkhash]: 返回入口特定chunk的hash。配置文件中定义的每个入口都有自己的hash。如果某个入口的任何部分发生了变化，这个入口的hash就会改变。</li>
<li>[contenthash]: 返回根据内容生成的hash。</li>
</ul>
<p>最好只在生产环境使用特定的hash或者chunkhash，因为在开发环境hash并没有很多好处。</p>
<p>我们还可以分隔hash或者chunkhash的长度，比如<code>[chunkhash:4]</code>，如果hash为8c4cbfdb91ff93f3f3c5，那么只会截取前4位为8c4c。</p>
<h2 id="Example-placeholder"><a href="#Example-placeholder" class="headerlink" title="Example placeholder"></a>Example placeholder</h2><p>假设你的配置如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: PATHS.build,</span><br><span class="line">    filename: <span class="string">"[name].[chunkhash].js"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>webpack生成的文件如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">main.d587bbd6e38337f5accd.js</span><br><span class="line">vendor.dc746a5db4ed650296e1.js</span><br></pre></td></tr></table></figure></p>
<p>如果某个chunk的文件内容改变，hash值就会改变，因此客户端缓存的该chunk失效，浏览器会请求新的文件。如果只有main bundle发生了更新，那么只会请求main。</p>
<h2 id="Setting-Up-Hashing"><a href="#Setting-Up-Hashing" class="headerlink" title="Setting Up Hashing"></a>Setting Up Hashing</h2><p>图片和字体应该使用hash，chunks应该使用chunkhash，所以可以这样设置：<br>webpack.config.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> productionConfig = merge([</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    output: &#123;</span><br><span class="line">      chunkFilename: <span class="string">"[name].[chunkhash:4].js"</span>,</span><br><span class="line">      filename: <span class="string">"[name].[chunkhash:4].js"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  parts.loadImages(&#123;</span><br><span class="line">    options: &#123;</span><br><span class="line">      limit: <span class="number">15000</span>,</span><br><span class="line">      name: <span class="string">"[name].[hash:4].[ext]"</span>,</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">  ...</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>对于<code>file-loader</code>，[hash]的定义不同于webpack中其他资源，它是根据文件内容计算的。因此这里图片都是用hash。此外，如果你对抽出的css文件使用chunkhash，那么在JS代码中引用css，会将css带入同一个entry，这意味着如果应用代码或者css改变，两个文件的文件名都会被改变。因此，你可以使用contenthash来代替chunkhash，因为contenthash是基于抽出的文件内容生成的，这样只有在样式文件内容发生改变时，抽出的文件hash才会发生变化。</p>
<p>webpack.parts.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>);</span><br><span class="line">exports.extractCSS = <span class="function">(<span class="params">&#123; include, exclude, use &#125; = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> plugin = <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">    filename: <span class="string">'styles/[name].[contenthash:4].css'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">      rules: [</span><br><span class="line">        &#123;</span><br><span class="line">          test: <span class="regexp">/\.css/</span>,</span><br><span class="line">          include,</span><br><span class="line">          exclude,</span><br><span class="line">          use: [MiniCssExtractPlugin.loader].concat(use),</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [plugin],</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里把以前的<code>extract-text-webpack-plugin</code>换成了<code>mini-css-extract-plugin</code>,因为使用contenthash时，<code>extract-text-webpack-plugin</code>会报错，可以参考这个<a href="https://github.com/webpack-contrib/extract-text-webpack-plugin/issues/763" target="_blank" rel="noopener">issue</a></p>
<p>编译运行一下，可以看到文件名都带有了hash值：<br><img src="/2018/05/04/surviveJS-webpack-optimizing/hash1.png" alt=""></p>
<p>现在还有个问题，如果修改应用代码，会导致vendor的hash值也发生变化。解决这个问题需要导出manifest.</p>
<h1 id="Separating-a-Manifest"><a href="#Separating-a-Manifest" class="headerlink" title="Separating a Manifest"></a>Separating a Manifest</h1>
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/02/surviveJS-webpack-building/" rel="next" title="surviveJS-webpack-building 学习笔记">
                <i class="fa fa-chevron-left"></i> surviveJS-webpack-building 学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Ailsa" />
            
              <p class="site-author-name" itemprop="name">Ailsa</p>
              <p class="site-description motion-element" itemprop="description">Front End Engineer</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Minifying"><span class="nav-number">1.</span> <span class="nav-text">Minifying</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Modifying-JavaScript-Minification-Process"><span class="nav-number">1.1.</span> <span class="nav-text">Modifying JavaScript Minification Process</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Speeding-Up-JavaScript-Execution"><span class="nav-number">1.2.</span> <span class="nav-text">Speeding Up JavaScript Execution</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#scope-hoisting"><span class="nav-number">1.2.1.</span> <span class="nav-text">scope hoisting</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pre-evaluation"><span class="nav-number">1.2.2.</span> <span class="nav-text">pre-evaluation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Minifying-HTML"><span class="nav-number">1.3.</span> <span class="nav-text">Minifying HTML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Minifying-CSS"><span class="nav-number">1.4.</span> <span class="nav-text">Minifying CSS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Minifying-Images"><span class="nav-number">1.5.</span> <span class="nav-text">Minifying Images</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tree-Shaking"><span class="nav-number">2.</span> <span class="nav-text">Tree Shaking</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Demonstrating-Tree-Shaking"><span class="nav-number">2.1.</span> <span class="nav-text">Demonstrating Tree Shaking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tree-Shaking-on-Package-Level"><span class="nav-number">2.2.</span> <span class="nav-text">Tree Shaking on Package Level</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">2.3.</span> <span class="nav-text">Conclusion</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Environment-Variables"><span class="nav-number">3.</span> <span class="nav-text">Environment Variables</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Basic-Idea-of-DefinePlugin"><span class="nav-number">3.1.</span> <span class="nav-text">The Basic Idea of DefinePlugin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#using-DefinePlugin"><span class="nav-number">3.2.</span> <span class="nav-text">using DefinePlugin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Choosing-Which-Module-to-Use"><span class="nav-number">3.3.</span> <span class="nav-text">Choosing Which Module to Use</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Adding-Hashes-to-Filenames"><span class="nav-number">4.</span> <span class="nav-text">Adding Hashes to Filenames</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#placeholders"><span class="nav-number">4.1.</span> <span class="nav-text">placeholders</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Example-placeholder"><span class="nav-number">4.2.</span> <span class="nav-text">Example placeholder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Setting-Up-Hashing"><span class="nav-number">4.3.</span> <span class="nav-text">Setting Up Hashing</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Separating-a-Manifest"><span class="nav-number">5.</span> <span class="nav-text">Separating a Manifest</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ailsa</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.6</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.6"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.6"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.6"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.6"></script>



  



	





  





  










  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("1nV85N21T6AO0avUlypxP9SI-gzGzoHsz", "wtpWsIgedu3sVOq1dgtWUiix");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
            counter.save(null, {
              success: function(counter) {
                
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.get('time'));
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  
  

  

  

  

  

</body>
</html>
